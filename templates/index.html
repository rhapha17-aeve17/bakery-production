<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² ì´ì»¤ë¦¬ ë§¤ì¥ ìƒì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        h1 { color: #333; margin-bottom: 30px; text-align: center; font-size: 2.5em; }
        h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: #333; margin-bottom: 15px; font-size: 1.2em; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
        .tab { padding: 12px 20px; background: none; border: none; cursor: pointer; font-size: 15px; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { color: #667eea; border-bottom: 3px solid #667eea; font-weight: bold; }
        .tab:hover { color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 70px; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:active { transform: translateY(0); }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 7px 14px; font-size: 13px; }
        .btn-secondary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-edit { background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); padding: 7px 14px; font-size: 13px; }
        .btn-recipe { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 7px 14px; font-size: 13px; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f5f5f5; font-weight: bold; color: #333; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f9f9f9; }
        .actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .message { padding: 12px 20px; border-radius: 8px; display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 300px; text-align: center; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.show { display: block; }
        .grid-container { margin-top: 15px; overflow: auto; max-height: 65vh; border: 2px solid #e0e0e0; border-radius: 8px; }
        .production-grid { width: 100%; border-collapse: separate; border-spacing: 0; }
        .production-grid th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: left; font-weight: bold; position: sticky; top: 0; z-index: 10; font-size: 12px; }
        .production-grid td { padding: 5px; border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; font-size: 12px; }
        .production-grid td:first-child { font-weight: 600; background: #f9f9f9; position: sticky; left: 0; z-index: 5; }
        .production-grid input[type="number"] { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-align: right; }
        .production-grid input[type="number"]:focus { outline: none; border-color: #667eea; background: #f0f4ff; }
        .production-grid tr:hover td { background: #f5f7ff; }
        .date-selector { display: flex; gap: 12px; align-items: center; margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; flex-wrap: wrap; }
        .date-selector input[type="date"] { flex: 0 0 180px; padding: 8px; }
        .date-selector button { padding: 8px 18px; }
        .stats-info { display: flex; gap: 12px; flex-wrap: wrap; }
        .stats-info div { padding: 8px 15px; background: white; border-radius: 6px; font-weight: 600; color: #667eea; font-size: 13px; }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .stat-card h3 { font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
        .stat-card .value { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .stat-card .detail { font-size: 12px; opacity: 0.8; margin-top: 4px; }
        .filter-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .filter-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .filter-row .form-group { flex: 1; min-width: 140px; margin-bottom: 0; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card { background: white; border-left: 5px solid #667eea; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .summary-card h3 { font-size: 13px; color: #666; margin-bottom: 8px; }
        .summary-card .value { font-size: 28px; font-weight: bold; color: #333; }
        .category-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .category-í˜ìŠ¤ì¸„ë¦¬ { background: #ffe4e1; color: #d63031; }
        .category-ë¹„ì—”ëˆ„ì•„ì¦ˆ { background: #fff3cd; color: #856404; }
        .category-ê±´ê°•ë¹µ { background: #d4edda; color: #155724; }
        .category-ìƒŒë“œìœ„ì¹˜ { background: #d1ecf1; color: #0c5460; }
        .category-ë°˜ì œí’ˆ { background: #e2e3e5; color: #383d41; }
        .category-ë¹„ì •ê¸° ì œí’ˆ { background: #e7d4ff; color: #6f42c1; }
        .category-ê¸°íƒ€ { background: #f8d7da; color: #721c24; }
        .stock-badge { display: inline-block; padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        .stock-ì¼ë°˜ { background: #cfe2ff; color: #084298; }
        .stock-íŠ¹ìˆ˜ { background: #f8d7da; color: #842029; }
        .stock-í”„ë© { background: #d1e7dd; color: #0f5132; }
        .type-ì›ìì¬ { background: #e7f3ff; color: #004085; }
        .type-ë¶€ìì¬ { background: #fff3cd; color: #856404; }
        .type-í”„ë© { background: #d1e7dd; color: #0f5132; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: #fefefe; margin: 3% auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .price-display { color: #28a745; font-weight: 600; }
        .cost-display { color: #dc3545; font-weight: 600; }
        .profit-display { color: #007bff; font-weight: 600; }
        .recipe-list { margin-top: 15px; }
        .recipe-item { background: #f9f9f9; padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .recipe-info { flex: 1; }
        .recipe-actions { display: flex; gap: 8px; }
        .add-material-form { background: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .cost-summary { background: #fff3cd; padding: 12px; border-radius: 6px; margin-top: 15px; }
        .cost-summary-large { font-size: 24px; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ ë² ì´ì»¤ë¦¬ ë§¤ì¥ ìƒì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

        <div id="message" class="message"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('grid')">ğŸ“ ì •ê¸° ì œí’ˆ</button>
            <button class="tab" onclick="switchTab('inventory')">ğŸ“¦ ì¬ê³ </button>
            <button class="tab" onclick="switchTab('sales')">ğŸ’° íŒë§¤</button>
            <button class="tab" onclick="switchTab('donation')">ğŸ ê¸°ë¶€</button>
            <button class="tab" onclick="switchTab('irregular')">ğŸ“Š ë¹„ì •ê¸° ì œí’ˆ</button>
            <button class="tab" onclick="switchTab('target')">ğŸ¯ ëª©í‘œ ìƒì‚°ëŸ‰</button>
            <button class="tab" onclick="switchTab('products')">ğŸ›ï¸ ì œí’ˆ ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('materials')">ğŸ“¦ ìì¬ ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('receipts')">ğŸ“¥ ì…ê³  ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('statistics')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="switchTab('ecount')">ğŸ”„ ì´ì¹´ìš´íŠ¸ ì—°ë™</button>
        </div>

        <!-- ì¼ê´„ ì…ë ¥ íƒ­ -->
        <div id="grid-tab" class="tab-content active">
            <div class="date-selector">
                <div>
                    <label for="grid-date">ìƒì‚° ë‚ ì§œ</label>
                    <input type="date" id="grid-date">
                </div>
                <button onclick="loadGridData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadGridData()" style="background: #28a745;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <div class="stats-info">
                    <div id="product-count">ì œí’ˆ: 0ê°œ</div>
                    <div id="filled-count">ì…ë ¥ë¨: 0ê°œ</div>
                    <div style="color: #28a745; font-size: 12px;">âœ“ ìë™ ì €ì¥</div>
                </div>
            </div>

            <!-- ì‹¤ì œ vs ëª©í‘œ ë¹„êµ -->
            <div class="summary-cards" style="margin-bottom: 15px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì‹¤ì œ ìƒì‚°ê¸ˆì•¡</h3>
                    <div class="value price-display" id="actual-amount">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>ëª©í‘œ ìƒì‚°ê¸ˆì•¡</h3>
                    <div class="value profit-display" id="target-amount">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h3>ì°¨ì´</h3>
                    <div class="value" id="variance-amount">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #dc3545;">
                    <h3>ë‹¬ì„±ë¥ </h3>
                    <div class="value" id="achievement-rate">0%</div>
                </div>
            </div>

            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 180px;">ì œí’ˆëª…</th>
                            <th style="min-width: 90px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 80px;">íŒë§¤ê°€</th>
                            <th style="min-width: 80px;">ì›ê°€</th>
                            <th style="min-width: 90px;">ëª©í‘œëŸ‰</th>
                            <th style="min-width: 110px;">ìƒì‚°ëŸ‰</th>
                            <th style="min-width: 80px;">ì°¨ì´</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body">
                        <tr><td colspan="8" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì¬ê³  ê´€ë¦¬ íƒ­ -->
        <div id="inventory-tab" class="tab-content">
            <h2>ì¬ê³  ê´€ë¦¬</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; color: #0c5460; font-size: 14px;">
                    ğŸ’¡ íŒë§¤ë˜ì§€ ì•Šì€ ìƒì‚°í’ˆì´ ì¬ê³ ë¡œ ë‚¨ìŠµë‹ˆë‹¤. ê° ë‚ ì§œë³„ë¡œ ì‹¤ì œ ì¬ê³ ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.
                </p>
            </div>

            <div class="date-selector">
                <div>
                    <label for="inventory-date">ì¬ê³  ë‚ ì§œ</label>
                    <input type="date" id="inventory-date">
                </div>
                <button onclick="loadInventoryData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadInventoryData()" style="background: #28a745;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <div class="stats-info">
                    <div id="inventory-product-count">ì œí’ˆ: 0ê°œ</div>
                    <div id="inventory-filled-count">ì…ë ¥ë¨: 0ê°œ</div>
                    <div style="color: #28a745; font-size: 12px;">âœ“ ìë™ ì €ì¥</div>
                </div>
            </div>

            <!-- ì¬ê³  í†µê³„ -->
            <div class="summary-cards" style="margin-bottom: 15px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì¬ê³  ì´ì•¡ (íŒë§¤ê°€ ê¸°ì¤€)</h3>
                    <div class="value price-display" id="inventory-total-value">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #4facfe;">
                    <h3>ì¼ë°˜ (ê¸°ë¶€) ì´ì•¡</h3>
                    <div class="value" style="color: #0c5460;" id="inventory-normal-value">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #f5576c;">
                    <h3>íŠ¹ìˆ˜ (ì¬ì‚¬ìš©) ì´ì•¡</h3>
                    <div class="value" style="color: #842029;" id="inventory-special-value">0ì›</div>
                </div>
            </div>

            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 180px;">ì œí’ˆëª…</th>
                            <th style="min-width: 90px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 70px;">ì¬ê³ ë°©ì‹</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 80px;">íŒë§¤ê°€</th>
                            <th style="min-width: 80px;">ì›ê°€</th>
                            <th style="min-width: 110px;">ì¬ê³ ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <tr><td colspan="7" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- íŒë§¤ ê´€ë¦¬ íƒ­ -->
        <div id="sales-tab" class="tab-content">
            <h2>ğŸ’° íŒë§¤ ë°ì´í„°</h2>

            <div class="date-selector">
                <div>
                    <label for="sales-date">íŒë§¤ ë‚ ì§œ</label>
                    <input type="date" id="sales-date">
                </div>
                <button onclick="loadSalesData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadSalesData()" style="background: #28a745;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <div class="stats-info">
                    <div id="sales-product-count">ì œí’ˆ: 0ê°œ</div>
                </div>
            </div>

            <!-- íŒë§¤ í†µê³„ -->
            <div class="summary-cards" style="margin-bottom: 15px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì •ê¸° íŒë§¤ê¸ˆì•¡</h3>
                    <div class="value price-display" id="sales-regular-revenue">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #4facfe;">
                    <h3>ë¹„ì •ê¸° íŒë§¤ê¸ˆì•¡</h3>
                    <div class="value price-display" id="sales-irregular-revenue">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>ì´ íŒë§¤ê¸ˆì•¡</h3>
                    <div class="value price-display" id="sales-total-revenue">0ì›</div>
                </div>
            </div>

            <!-- ì •ê¸° ì œí’ˆ íŒë§¤ -->
            <h3 style="margin-top: 20px; margin-bottom: 10px;">ğŸ“¦ ì •ê¸° ì œí’ˆ</h3>
            <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 13px; color: #0c5460;">
                íŒë§¤ëŸ‰ = ê¸°ì´ˆì¬ê³  + ìƒì‚°ëŸ‰ - ê¸°ë§ì¬ê³ 
            </div>
            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">ì œí’ˆëª…</th>
                            <th style="min-width: 90px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 70px;">íŒë§¤ê°€</th>
                            <th style="min-width: 70px;">ì›ê°€</th>
                            <th style="min-width: 80px;">ìƒì‚°ëŸ‰</th>
                            <th style="min-width: 80px;">ê¸°ë§ì¬ê³ </th>
                            <th style="min-width: 80px; background: #fff3cd; color: #000;">íŒë§¤ëŸ‰</th>
                            <th style="min-width: 90px;">íŒë§¤ê¸ˆì•¡</th>
                            <th style="min-width: 80px;">ë§ˆì§„</th>
                        </tr>
                    </thead>
                    <tbody id="sales-regular-body">
                        <tr><td colspan="10" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ë¹„ì •ê¸° ì œí’ˆ íŒë§¤ -->
            <h3 style="margin-top: 30px; margin-bottom: 10px;">ğŸ ë¹„ì •ê¸° ì œí’ˆ</h3>
            <div style="background: #fff3e0; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 13px; color: #e65100;">
                íŒë§¤ëŸ‰ = ê¸°ì´ˆì¬ê³  + ìƒì‚°ëŸ‰ - ê¸°ë¶€ëŸ‰ - ê¸°ë§ì¬ê³ 
            </div>
            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">ì œí’ˆëª…</th>
                            <th style="min-width: 90px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 70px;">íŒë§¤ê°€</th>
                            <th style="min-width: 70px;">ì›ê°€</th>
                            <th style="min-width: 80px;">ê¸°ì´ˆì¬ê³ </th>
                            <th style="min-width: 80px;">ìƒì‚°ëŸ‰</th>
                            <th style="min-width: 80px;">ê¸°ë¶€ëŸ‰</th>
                            <th style="min-width: 80px;">ê¸°ë§ì¬ê³ </th>
                            <th style="min-width: 80px; background: #fff3cd; color: #000;">íŒë§¤ëŸ‰</th>
                            <th style="min-width: 90px;">íŒë§¤ê¸ˆì•¡</th>
                            <th style="min-width: 80px;">ë§ˆì§„</th>
                        </tr>
                    </thead>
                    <tbody id="sales-irregular-body">
                        <tr><td colspan="12" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ê¸°ë¶€ ê´€ë¦¬ íƒ­ -->
        <div id="donation-tab" class="tab-content">
            <h2>ğŸ ê¸°ë¶€ ë°ì´í„°</h2>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; color: #2e7d32; font-size: 14px;">
                    ğŸ’¡ ì •ê¸° ì œí’ˆ(ì¼ë°˜ ì¬ê³ )ì˜ ì¬ê³ ëŸ‰ê³¼ ë¹„ì •ê¸° ì œí’ˆì˜ ê¸°ë¶€ëŸ‰ì„ ì¡°íšŒí•©ë‹ˆë‹¤
                </p>
            </div>

            <div class="date-selector">
                <div>
                    <label for="donation-date">ê¸°ë¶€ ë‚ ì§œ</label>
                    <input type="date" id="donation-date">
                </div>
                <button onclick="loadDonationData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadDonationData()" style="background: #28a745;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <div class="stats-info">
                    <div id="donation-product-count">ì œí’ˆ: 0ê°œ</div>
                </div>
            </div>

            <!-- ê¸°ë¶€ í†µê³„ -->
            <div class="summary-cards" style="margin-bottom: 15px;">
                <div class="summary-card" style="border-left-color: #4caf50;">
                    <h3>ì´ ê¸°ë¶€ ìˆ˜ëŸ‰</h3>
                    <div class="value" style="color: #4caf50;" id="donation-total-quantity">0ê°œ</div>
                </div>
                <div class="summary-card" style="border-left-color: #8bc34a;">
                    <h3>ì´ ê¸°ë¶€ ê¸ˆì•¡</h3>
                    <div class="value price-display" id="donation-total-amount">0ì›</div>
                </div>
            </div>

            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">ì œí’ˆëª…</th>
                            <th style="min-width: 90px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 80px;">ì œí’ˆ êµ¬ë¶„</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 80px;">íŒë§¤ê°€</th>
                            <th style="min-width: 80px; background: #c8e6c9; color: #000;">ê¸°ë¶€ëŸ‰</th>
                            <th style="min-width: 100px;">ê¸°ë¶€ ê¸ˆì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="donation-body">
                        <tr><td colspan="7" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë¹„ì •ê¸° ì œí’ˆ íƒ­ -->
        <div id="irregular-tab" class="tab-content">
            <h2>ë¹„ì •ê¸° ì œí’ˆ</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; color: #0c5460; font-size: 14px;">
                    ğŸ’¡ 2ì¼ ì´ìƒ ì§„ì—´í•˜ëŠ” ì œí’ˆì˜ ì¬ê³ ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ê¸°ì´ˆì¬ê³  + ìƒì‚°ëŸ‰ - ê¸°ë¶€ëŸ‰ - ê¸°ë§ì¬ê³  = íŒë§¤ëŸ‰
                </p>
            </div>

            <div class="date-selector">
                <div>
                    <label for="irregular-date">ê¸°ë¡ ë‚ ì§œ</label>
                    <input type="date" id="irregular-date" onchange="loadIrregularData()">
                </div>
                <button onclick="loadIrregularData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadIrregularData()" style="background: #28a745;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <div class="stats-info">
                    <div id="irregular-product-count">ì œí’ˆ: 0ê°œ</div>
                    <div id="irregular-filled-count">ì…ë ¥ë¨: 0ê°œ</div>
                    <div style="color: #28a745; font-size: 12px;">âœ“ ìë™ ì €ì¥</div>
                </div>
            </div>

            <!-- íŒë§¤ëŸ‰ í†µê³„ -->
            <div class="summary-cards" style="margin-bottom: 15px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì´ íŒë§¤ëŸ‰</h3>
                    <div class="value" style="color: #667eea;" id="irregular-total-sales">0ê°œ</div>
                </div>
                <div class="summary-card" style="border-left-color: #4facfe;">
                    <h3>ì´ íŒë§¤ì•¡ (íŒë§¤ê°€ ê¸°ì¤€)</h3>
                    <div class="value price-display" id="irregular-total-revenue">0ì›</div>
                </div>
            </div>

            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 140px;">ì œí’ˆëª…</th>
                            <th style="min-width: 50px;">ë‹¨ìœ„</th>
                            <th style="min-width: 80px;">íŒë§¤ê°€</th>
                            <th style="min-width: 90px;">ì „ë‚  ê¸°ë§ì¬ê³ </th>
                            <th style="min-width: 90px;">ê¸°ì´ˆì¬ê³ </th>
                            <th style="min-width: 70px;">ì˜¤ì°¨</th>
                            <th style="min-width: 90px;">ìƒì‚°ëŸ‰</th>
                            <th style="min-width: 90px;">ê¸°ë¶€ëŸ‰</th>
                            <th style="min-width: 90px;">ê¸°ë§ì¬ê³ </th>
                            <th style="min-width: 90px;">íŒë§¤ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody id="irregular-body">
                        <tr><td colspan="10" class="empty-state">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  "ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ëª©í‘œ ìƒì‚°ëŸ‰ íƒ­ -->
        <div id="target-tab" class="tab-content">
            <h2>ëª©í‘œ ìƒì‚°ëŸ‰ ì„¤ì •</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; color: #0c5460; font-size: 14px;">
                    ğŸ’¡ í‰ì¼ê³¼ ì£¼ë§ì˜ ëª©í‘œ ìƒì‚°ëŸ‰ì„ ê°ê° ì„¤ì •í•˜ì„¸ìš”. ì¼ê´„ ì…ë ¥ í˜ì´ì§€ì—ì„œ ì„ íƒí•œ ë‚ ì§œì˜ ìš”ì¼ì— ë§ëŠ” ëª©í‘œëŸ‰ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ëª©í‘œ ìƒì‚°ëŸ‰ í†µê³„ -->
            <div class="summary-cards" style="margin-bottom: 20px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>í‰ì¼ ëª©í‘œ ìƒì‚°ê¸ˆì•¡</h3>
                    <div class="value price-display" id="weekday-target-amount">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #dc3545;">
                    <h3>í‰ì¼ ëª©í‘œ ì›ê°€</h3>
                    <div class="value cost-display" id="weekday-target-cost">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>í‰ì¼ ì˜ˆìƒ ì´ìµ</h3>
                    <div class="value profit-display" id="weekday-target-profit">0ì›</div>
                </div>
            </div>

            <div class="summary-cards" style="margin-bottom: 20px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì£¼ë§ ëª©í‘œ ìƒì‚°ê¸ˆì•¡</h3>
                    <div class="value price-display" id="weekend-target-amount">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #dc3545;">
                    <h3>ì£¼ë§ ëª©í‘œ ì›ê°€</h3>
                    <div class="value cost-display" id="weekend-target-cost">0ì›</div>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>ì£¼ë§ ì˜ˆìƒ ì´ìµ</h3>
                    <div class="value profit-display" id="weekend-target-profit">0ì›</div>
                </div>
            </div>

            <div style="text-align: right; margin-bottom: 15px;">
                <button class="btn-success" onclick="saveTargetData()">ğŸ’¾ ì €ì¥</button>
            </div>

            <div class="grid-container">
                <table class="production-grid">
                    <thead>
                        <tr>
                            <th style="min-width: 200px;">ì œí’ˆëª…</th>
                            <th style="min-width: 100px;">ì¹´í…Œê³ ë¦¬</th>
                            <th style="min-width: 60px;">ë‹¨ìœ„</th>
                            <th style="min-width: 90px;">íŒë§¤ê°€</th>
                            <th style="min-width: 120px;">í‰ì¼ ëª©í‘œëŸ‰</th>
                            <th style="min-width: 120px;">ì£¼ë§ ëª©í‘œëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody id="target-body">
                        <tr><td colspan="6" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì œí’ˆ ê´€ë¦¬ íƒ­ -->
        <div id="products-tab" class="tab-content">
            <h2>ìƒˆ ì œí’ˆ ì¶”ê°€</h2>
            <form id="product-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-name">ì œí’ˆëª… *</label>
                        <input type="text" id="product-name" required placeholder="ì˜ˆ: í¬ë£¨ì•„ìƒ">
                    </div>
                    <div class="form-group">
                        <label for="product-category">ì¹´í…Œê³ ë¦¬ *</label>
                        <select id="product-category" required>
                            <option value="í˜ìŠ¤ì¸„ë¦¬">í˜ìŠ¤ì¸„ë¦¬</option>
                            <option value="ë¹„ì—”ëˆ„ì•„ì¦ˆ">ë¹„ì—”ëˆ„ì•„ì¦ˆ</option>
                            <option value="ê±´ê°•ë¹µ">ê±´ê°•ë¹µ</option>
                            <option value="ìƒŒë“œìœ„ì¹˜">ìƒŒë“œìœ„ì¹˜</option>
                            <option value="ë°˜ì œí’ˆ">ë°˜ì œí’ˆ</option>
                            <option value="ë¹„ì •ê¸° ì œí’ˆ">ë¹„ì •ê¸° ì œí’ˆ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-stock-type">ì¬ê³  ì²˜ë¦¬ ë°©ì‹ *</label>
                        <select id="product-stock-type" required>
                            <option value="ì¼ë°˜">ì¼ë°˜</option>
                            <option value="íŠ¹ìˆ˜">íŠ¹ìˆ˜</option>
                            <option value="í”„ë©">í”„ë©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-unit">ë‹¨ìœ„ *</label>
                        <input type="text" id="product-unit" required placeholder="ì˜ˆ: ê°œ">
                    </div>
                    <div class="form-group">
                        <label for="product-price">íŒë§¤ ê°€ê²© (ì›) *</label>
                        <input type="number" id="product-price" step="100" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="product-ecount-code">ì´ì¹´ìš´íŠ¸ ì œí’ˆì½”ë“œ</label>
                        <input type="text" id="product-ecount-code" placeholder="ì˜ˆ: PROD001">
                        <small style="color: #666; font-size: 11px;">ì´ì¹´ìš´íŠ¸ ì—°ë™ ì‹œ í•„ìˆ˜</small>
                    </div>
                    <div class="form-group">
                        <label for="product-order">No (ìˆœì„œ) *</label>
                        <input type="number" id="product-order" min="1" required placeholder="1">
                        <small style="color: #666; font-size: 11px;">ì‘ì€ ë²ˆí˜¸ê°€ ë¨¼ì € í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                </div>
                <button type="submit">ì œí’ˆ ì¶”ê°€</button>
            </form>

            <h2 style="margin-top: 30px;">ì œí’ˆ ëª©ë¡</h2>

            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="filter-section" style="margin-bottom: 15px;">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="product-search">ì œí’ˆëª… ê²€ìƒ‰</label>
                        <input type="text" id="product-search" placeholder="ì œí’ˆëª… ì…ë ¥..." onkeyup="filterProducts()">
                    </div>
                    <div class="form-group">
                        <label for="product-category-filter">ì¹´í…Œê³ ë¦¬</label>
                        <select id="product-category-filter" onchange="filterProducts()">
                            <option value="">ì „ì²´</option>
                            <option value="í˜ìŠ¤ì¸„ë¦¬">í˜ìŠ¤ì¸„ë¦¬</option>
                            <option value="ë¹„ì—”ëˆ„ì•„ì¦ˆ">ë¹„ì—”ëˆ„ì•„ì¦ˆ</option>
                            <option value="ê±´ê°•ë¹µ">ê±´ê°•ë¹µ</option>
                            <option value="ìƒŒë“œìœ„ì¹˜">ìƒŒë“œìœ„ì¹˜</option>
                            <option value="ë°˜ì œí’ˆ">ë°˜ì œí’ˆ</option>
                            <option value="ë¹„ì •ê¸° ì œí’ˆ">ë¹„ì •ê¸° ì œí’ˆ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-stock-filter">ì¬ê³ ë°©ì‹</label>
                        <select id="product-stock-filter" onchange="filterProducts()">
                            <option value="">ì „ì²´</option>
                            <option value="ì¼ë°˜">ì¼ë°˜</option>
                            <option value="íŠ¹ìˆ˜">íŠ¹ìˆ˜</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn-secondary" onclick="resetProductFilter()">ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table id="products-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">No</th>
                            <th>ì œí’ˆëª…</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>ì¬ê³ ë°©ì‹</th>
                            <th>ë‹¨ìœ„</th>
                            <th>íŒë§¤ê°€</th>
                            <th>ì›ê°€(ë ˆì‹œí”¼)</th>
                            <th>ì›ê°€ìœ¨</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ìì¬ ê´€ë¦¬ íƒ­ -->
        <div id="materials-tab" class="tab-content">
            <h2>ìƒˆ ìì¬ ì¶”ê°€</h2>
            <form id="material-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="material-name">ìì¬ëª… *</label>
                        <input type="text" id="material-name" required placeholder="ì˜ˆ: ë°€ê°€ë£¨, ê³„ë€, ìš°ìœ ">
                    </div>
                    <div class="form-group">
                        <label for="material-type">ìœ í˜• *</label>
                        <select id="material-type" required onchange="handleMaterialTypeChange()">
                            <option value="ì›ìì¬">ì›ìì¬</option>
                            <option value="ë¶€ìì¬">ë¶€ìì¬</option>
                            <option value="í”„ë©">í”„ë©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="material-weight">ìˆ˜ëŸ‰ *</label>
                        <input type="number" id="material-weight" step="0.01" required placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label for="material-unit">ë‹¨ìœ„ *</label>
                        <select id="material-unit" required onchange="handleUnitChange()">
                            <option value="g">g (ê·¸ë¨)</option>
                            <option value="kg">kg (í‚¬ë¡œê·¸ë¨)</option>
                            <option value="EA">EA (ê°œ)</option>
                            <option value="PK">PK (í¬ì¥)</option>
                            <option value="L">L (ë¦¬í„°)</option>
                            <option value="ml">ml (ë°€ë¦¬ë¦¬í„°)</option>
                            <option value="custom">ì§ì ‘ ì…ë ¥...</option>
                        </select>
                        <input type="text" id="material-unit-custom" style="display:none; margin-top:5px;" placeholder="ë‹¨ìœ„ ì…ë ¥">
                    </div>
                    <div class="form-group" id="material-price-group">
                        <label for="material-price">ì…ê³  ë‹¨ê°€ (ì›) *</label>
                        <input type="number" id="material-price" step="1" required placeholder="5000">
                        <small style="color: #999; font-size: 11px; display: none;" id="material-price-note">í”„ë© ìì¬ëŠ” ë ˆì‹œí”¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</small>
                    </div>
                    <div class="form-group">
                        <label for="material-supplier">ê³µê¸‰ì—…ì²´</label>
                        <input type="text" id="material-supplier" placeholder="ì„ íƒì‚¬í•­">
                    </div>
                    <div class="form-group">
                        <label for="material-ecount-code">ì´ì¹´ìš´íŠ¸ ì œí’ˆì½”ë“œ</label>
                        <input type="text" id="material-ecount-code" placeholder="ì˜ˆ: MAT001">
                        <small style="color: #666; font-size: 11px;">ì´ì¹´ìš´íŠ¸ ì—°ë™ ì‹œ í•„ìˆ˜</small>
                    </div>
                </div>
                <button type="submit">ìì¬ ì¶”ê°€</button>
            </form>

            <h2 style="margin-top: 30px;">ìì¬ ëª©ë¡</h2>
            <div style="overflow-x: auto;">
                <table id="materials-table">
                    <thead>
                        <tr>
                            <th>ìì¬ëª…</th>
                            <th>ìœ í˜•</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ë‹¨ìœ„</th>
                            <th>ì…ê³  ë‹¨ê°€</th>
                            <th>ë‹¨ìœ„ë‹¹ ê°€ê²©</th>
                            <th>ê³µê¸‰ì—…ì²´</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ì…ê³  ê´€ë¦¬ íƒ­ -->
        <div id="receipts-tab" class="tab-content">
            <h2>ğŸ“¥ ìì¬ ì…ê³  ê´€ë¦¬</h2>

            <!-- ì…ê³  ë“±ë¡ í¼ -->
            <div class="form-container">
                <h3>ì…ê³  ë“±ë¡</h3>
                <form id="receipt-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receipt-material">ìì¬</label>
                            <select id="receipt-material" required>
                                <option value="">ìì¬ ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="receipt-date">ì…ê³  ë‚ ì§œ</label>
                            <input type="date" id="receipt-date" required>
                        </div>
                        <div class="form-group">
                            <label for="receipt-quantity">ìˆ˜ëŸ‰</label>
                            <input type="number" id="receipt-quantity" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="receipt-unit-price">ë‹¨ê°€ (ì›)</label>
                            <input type="number" id="receipt-unit-price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receipt-supplier">ê³µê¸‰ì—…ì²´</label>
                            <input type="text" id="receipt-supplier" placeholder="ê³µê¸‰ì—…ì²´ëª…">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="receipt-note">ë¹„ê³ </label>
                            <input type="text" id="receipt-note" placeholder="ë¹„ê³ ì‚¬í•­">
                        </div>
                    </div>
                    <button type="submit" class="btn">ì…ê³  ë“±ë¡</button>
                </form>
            </div>

            <!-- ì…ê³  ì´ë ¥ í•„í„° -->
            <div class="date-selector" style="margin-top: 30px;">
                <div>
                    <label for="receipt-filter-material">ìì¬ í•„í„°</label>
                    <select id="receipt-filter-material" onchange="loadReceipts()">
                        <option value="">ì „ì²´ ìì¬</option>
                    </select>
                </div>
                <div>
                    <label for="receipt-filter-start">ì‹œì‘ì¼</label>
                    <input type="date" id="receipt-filter-start" onchange="loadReceipts()">
                </div>
                <div>
                    <label for="receipt-filter-end">ì¢…ë£Œì¼</label>
                    <input type="date" id="receipt-filter-end" onchange="loadReceipts()">
                </div>
                <button onclick="loadReceipts()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <!-- ì…ê³  ì´ë ¥ í…Œì´ë¸” -->
            <div class="table-container">
                <table id="receipts-table">
                    <thead>
                        <tr>
                            <th>ì…ê³ ì¼</th>
                            <th>ìì¬ëª…</th>
                            <th>êµ¬ë¶„</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ë‹¨ìœ„</th>
                            <th>ë‹¨ê°€</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ê³µê¸‰ì—…ì²´</th>
                            <th>ë¹„ê³ </th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- ìì¬ë³„ í˜„ì¬ í‰ê·  ë‹¨ê°€ -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3>ìì¬ë³„ í˜„ì¬ í‰ê·  ë‹¨ê°€ (ê°€ì¤‘í‰ê· ë²•)</h3>
                <div id="material-avg-prices" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <!-- ìì¬ë³„ í‰ê·  ë‹¨ê°€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

        <!-- í†µê³„ íƒ­ -->
        <div id="statistics-tab" class="tab-content">
            <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>

            <!-- ê¸°ê°„ ì„ íƒ -->
            <div class="date-selector" style="margin-bottom: 20px;">
                <div>
                    <label for="dashboard-days">ì¡°íšŒ ê¸°ê°„</label>
                    <select id="dashboard-days" onchange="loadDashboard()">
                        <option value="7">ìµœê·¼ 7ì¼</option>
                        <option value="14">ìµœê·¼ 14ì¼</option>
                        <option value="30" selected>ìµœê·¼ 30ì¼</option>
                    </select>
                </div>
                <button onclick="loadDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì´ íŒë§¤ê¸ˆì•¡</h3>
                    <div class="value price-display" id="dashboard-total-sales">0ì›</div>
                    <small style="color: #666;">ì„ íƒí•œ ê¸°ê°„ ë™ì•ˆ</small>
                </div>
                <div class="summary-card" style="border-left-color: #4facfe;">
                    <h3>ì´ ìƒì‚°ê¸ˆì•¡</h3>
                    <div class="value price-display" id="dashboard-total-production">0ì›</div>
                    <small style="color: #666;">ì„ íƒí•œ ê¸°ê°„ ë™ì•ˆ</small>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>ì´ ë§ˆì§„</h3>
                    <div class="value profit-display" id="dashboard-total-margin">0ì›</div>
                    <small style="color: #666;">íŒë§¤ê¸ˆì•¡ - ì›ê°€</small>
                </div>
                <div class="summary-card" style="border-left-color: #ff6b6b;">
                    <h3>ì´ ê¸°ë¶€ ê¸ˆì•¡</h3>
                    <div class="value" style="color: #ff6b6b;" id="dashboard-total-donation">0ì›</div>
                    <small style="color: #666;">ê¸°ë¶€ ì´ì•¡</small>
                </div>
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h3>í‰ê·  ë§ˆì§„ìœ¨</h3>
                    <div class="value" id="dashboard-avg-margin-rate">0%</div>
                    <small style="color: #666;">ë§ˆì§„ / íŒë§¤ê¸ˆì•¡</small>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“ˆ ì¼ë³„ íŒë§¤ ì¶”ì´</h3>
                    <div style="height: 300px;">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">ğŸ¥§ ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ ë¹„ì¤‘</h3>
                    <div style="height: 300px;">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">ğŸ† ì œí’ˆë³„ íŒë§¤ TOP 5</h3>
                    <div style="height: 350px;">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“‰ ì œí’ˆë³„ íŒë§¤ WORST 5</h3>
                    <div style="height: 350px;">
                        <canvas id="worstProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì´ì¹´ìš´íŠ¸ ì—°ë™ íƒ­ -->
        <div id="ecount-tab" class="tab-content">
            <h2>ğŸ”„ ì´ì¹´ìš´íŠ¸ ERP ì—°ë™</h2>

            <!-- ì—°ë™ ì„¤ì • ì„¹ì…˜ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">âš™ï¸ ì´ì¹´ìš´íŠ¸ API ì„¤ì •</h3>
                <form id="ecount-settings-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ecount-com-code">íšŒì‚¬ ì½”ë“œ (COM_CODE) *</label>
                            <input type="text" id="ecount-com-code" maxlength="6" placeholder="6ìë¦¬ íšŒì‚¬ ì½”ë“œ" required>
                        </div>
                        <div class="form-group">
                            <label for="ecount-user-id">ì‚¬ìš©ì ID (USER_ID) *</label>
                            <input type="text" id="ecount-user-id" placeholder="ì´ì¹´ìš´íŠ¸ ì‚¬ìš©ì ID" required>
                        </div>
                        <div class="form-group">
                            <label for="ecount-zone">ì¡´ (ZONE) *</label>
                            <input type="text" id="ecount-zone" maxlength="2" placeholder="ì˜ˆ: CC" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ecount-wh-cd">ì°½ê³  ì½”ë“œ (WH_CD)</label>
                            <input type="text" id="ecount-wh-cd" maxlength="10" placeholder="ê¸°ë³¸ê°’: 001" value="001">
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                ğŸ’¡ ì´ì¹´ìš´íŠ¸ ì¬ê³ ê´€ë¦¬ > ê¸°ì´ˆì •ë³´ > ì°½ê³ ê´€ë¦¬ì—ì„œ ì°½ê³  ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.
                            </small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ecount-api-key">API ì¸ì¦í‚¤ (API_CERT_KEY) *</label>
                        <input type="password" id="ecount-api-key" placeholder="ì´ì¹´ìš´íŠ¸ API ì¸ì¦í‚¤" required>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            ğŸ’¡ ì´ì¹´ìš´íŠ¸ > ì…€í”„ì»¤ìŠ¤í„°ë§ˆì´ì§• > ì •ë³´ê´€ë¦¬ > API ì¸ì¦í‚¤ë°œê¸‰ ë©”ë‰´ì—ì„œ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.
                        </small>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="submit" class="btn-success">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                        <button type="button" onclick="testEcountConnection()" class="btn-secondary">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                        <button type="button" onclick="loadEcountSettings()" class="btn-small">ğŸ”„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </form>
            </div>

            <!-- ì œí’ˆ ì½”ë“œ ìë™ ë§¤ì¹­ ì„¹ì…˜ -->
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ”— ì´ì¹´ìš´íŠ¸ ì œí’ˆ ì½”ë“œ ìë™ ë§¤ì¹­</h3>
                <p style="color: #1565c0; margin-bottom: 15px; font-size: 14px;">
                    ğŸ’¡ ì´ì¹´ìš´íŠ¸ í’ˆëª© ë“±ë¡ ì—‘ì…€ì„ CSVë¡œ ì €ì¥í•œ í›„ ì—…ë¡œë“œí•˜ë©´, ì œí’ˆëª…ì´ ì¼ì¹˜í•˜ëŠ” í•­ëª©ì˜ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ë§¤ì¹­í•´ë“œë¦½ë‹ˆë‹¤.<br>
                    âš ï¸ ìì¬ëŠ” <strong>ì›ìì¬</strong> ìœ í˜•ë§Œ ë§¤ì¹­ë©ë‹ˆë‹¤ (ë¶€ìì¬, í”„ë©ì€ ì œì™¸).
                </p>

                <div class="form-group">
                    <label>CSV íŒŒì¼ ì—…ë¡œë“œ (í’ˆëª©ì½”ë“œ, í’ˆëª©ëª… í¬í•¨)</label>
                    <input type="file" id="ecount-csv-file" accept=".csv" onchange="parseEcountCSV(event)" style="margin-top: 5px;">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        â„¹ï¸ ì—‘ì…€ íŒŒì¼ì„ CSV(ì‰¼í‘œë¡œ ë¶„ë¦¬)ë¡œ ì €ì¥í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”. í’ˆëª©ì½”ë“œì™€ í’ˆëª©ëª… ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </small>
                </div>

                <!-- ë§¤ì¹­ ê²°ê³¼ -->
                <div id="match-results" style="display: none; margin-top: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">ğŸ“Š ë§¤ì¹­ ê²°ê³¼</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <div>
                                <strong>ì´ ì œí’ˆ:</strong> <span id="match-total-products">0</span>ê°œ
                            </div>
                            <div style="color: #28a745;">
                                <strong>ë§¤ì¹­ ì„±ê³µ:</strong> <span id="match-success-products">0</span>ê°œ
                            </div>
                            <div>
                                <strong>ì´ ìì¬:</strong> <span id="match-total-materials">0</span>ê°œ
                            </div>
                            <div style="color: #28a745;">
                                <strong>ë§¤ì¹­ ì„±ê³µ:</strong> <span id="match-success-materials">0</span>ê°œ
                            </div>
                        </div>
                    </div>

                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead style="position: sticky; top: 0; background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ìœ í˜•</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ì´ë¦„</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">í˜„ì¬ ì½”ë“œ</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ì œì•ˆ ì½”ë“œ</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ìƒíƒœ</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ì„ íƒ</th>
                                </tr>
                            </thead>
                            <tbody id="match-results-body"></tbody>
                        </table>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="applySelectedMatches()" class="btn-success">âœ… ì„ íƒ í•­ëª© ì ìš©</button>
                        <button onclick="applyAllMatches()" class="btn-primary">âœ… ëª¨ë‘ ì ìš©</button>
                        <button onclick="clearMatchResults()" class="btn-secondary">ğŸ—‘ï¸ ê²°ê³¼ ì§€ìš°ê¸°</button>
                    </div>
                </div>
            </div>

            <!-- ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ“Š ì´ì¹´ìš´íŠ¸ ì—‘ì…€ë¡œ ì œí’ˆ/ìì¬ ëŒ€ëŸ‰ ë“±ë¡</h3>
                <p style="color: #2e7d32; margin-bottom: 15px; font-size: 14px;">
                    ì´ì¹´ìš´íŠ¸ í’ˆëª©ë“±ë¡ ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì—…ë¡œë“œí•˜ë©´ <strong>í’ˆëª©êµ¬ë¶„</strong>ì— ë”°ë¼ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤.<br>
                    â€¢ <strong>ì›ìì¬</strong> â†’ ìì¬ ê´€ë¦¬ì— ë“±ë¡<br>
                    â€¢ <strong>ë‚˜ë¨¸ì§€</strong> (ì œí’ˆ, ìƒí’ˆ ë“±) â†’ ì œí’ˆ ê´€ë¦¬ì— ë“±ë¡<br>
                    âš ï¸ ì´ë¯¸ ê°™ì€ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ í•­ëª©ì€ ê±´ë„ˆëœë‹ˆë‹¤.
                </p>
                <div class="form-group">
                    <label>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (.xlsx)</label>
                    <input type="file" id="excel-upload-file" accept=".xlsx,.xls" style="margin-top: 5px;">
                </div>
                <button onclick="uploadExcelFile()" class="btn-success">ğŸ“¤ ì—…ë¡œë“œ ë° ë“±ë¡</button>
                <div id="excel-upload-result" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;"></div>
            </div>

            <!-- ì—°ë™ í†µê³„ -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="summary-card" style="border-left-color: #667eea;">
                    <h3>ì´ ë™ê¸°í™”</h3>
                    <div class="value" id="ecount-stat-total">0ê±´</div>
                </div>
                <div class="summary-card" style="border-left-color: #28a745;">
                    <h3>ì„±ê³µ</h3>
                    <div class="value profit-display" id="ecount-stat-success">0ê±´</div>
                </div>
                <div class="summary-card" style="border-left-color: #dc3545;">
                    <h3>ì‹¤íŒ¨</h3>
                    <div class="value cost-display" id="ecount-stat-failed">0ê±´</div>
                </div>
                <div class="summary-card" style="border-left-color: #ffc107;">
                    <h3>ì„±ê³µë¥ </h3>
                    <div class="value" style="color: #ffc107;" id="ecount-stat-rate">0%</div>
                </div>
            </div>

            <!-- ìˆ˜ë™ ë™ê¸°í™” ì„¹ì…˜ -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ“¤ ìˆ˜ë™ ë°ì´í„° ë™ê¸°í™”</h3>
                <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">
                    ìƒì‚° ì‹¤ì ì€ ì´ì¹´ìš´íŠ¸ 'íŒë§¤' ë°ì´í„°ë¡œ, ìì¬ ì…ê³ ëŠ” 'ë§¤ì…' ë°ì´í„°ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
                </p>
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>ë™ê¸°í™” ìœ í˜•</label>
                            <select id="sync-type">
                                <option value="production">ìƒì‚° ì‹¤ì  â†’ íŒë§¤</option>
                                <option value="receipt">ìì¬ ì…ê³  â†’ ë§¤ì…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì‹œì‘ ë‚ ì§œ</label>
                            <input type="date" id="sync-start-date">
                        </div>
                        <div class="form-group">
                            <label>ì¢…ë£Œ ë‚ ì§œ</label>
                            <input type="date" id="sync-end-date">
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 10px;">
                            <button onclick="syncDataByDateRange()" class="btn-success">ğŸ”„ ì„ íƒ ê¸°ê°„ ë™ê¸°í™”</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë™ê¸°í™” ë¡œê·¸ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ğŸ“‹ ë™ê¸°í™” ë¡œê·¸</h3>
                    <div style="display: flex; gap: 10px;">
                        <select id="log-filter-type" onchange="loadEcountLogs()">
                            <option value="">ì „ì²´ ìœ í˜•</option>
                            <option value="sale">íŒë§¤ (ìƒì‚°ì‹¤ì )</option>
                            <option value="purchase">ë§¤ì… (ìì¬ì…ê³ )</option>
                        </select>
                        <button onclick="loadEcountLogs()" class="btn-small">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ìœ í˜•</th>
                                <th>ë ˆì½”ë“œ ID</th>
                                <th>ìƒíƒœ</th>
                                <th>ì˜¤ë¥˜ ë©”ì‹œì§€</th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="ecount-logs-tbody">
                            <tr>
                                <td colspan="6" class="empty-state">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ì œí’ˆ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì œí’ˆ ìˆ˜ì •</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-product-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-product-name">ì œí’ˆëª… *</label>
                        <input type="text" id="edit-product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-category">ì¹´í…Œê³ ë¦¬ *</label>
                        <select id="edit-product-category" required>
                            <option value="í˜ìŠ¤ì¸„ë¦¬">í˜ìŠ¤ì¸„ë¦¬</option>
                            <option value="ë¹„ì—”ëˆ„ì•„ì¦ˆ">ë¹„ì—”ëˆ„ì•„ì¦ˆ</option>
                            <option value="ê±´ê°•ë¹µ">ê±´ê°•ë¹µ</option>
                            <option value="ìƒŒë“œìœ„ì¹˜">ìƒŒë“œìœ„ì¹˜</option>
                            <option value="ë°˜ì œí’ˆ">ë°˜ì œí’ˆ</option>
                            <option value="ë¹„ì •ê¸° ì œí’ˆ">ë¹„ì •ê¸° ì œí’ˆ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-stock-type">ì¬ê³  ì²˜ë¦¬ ë°©ì‹ *</label>
                        <select id="edit-product-stock-type" required>
                            <option value="ì¼ë°˜">ì¼ë°˜</option>
                            <option value="íŠ¹ìˆ˜">íŠ¹ìˆ˜</option>
                            <option value="í”„ë©">í”„ë©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-unit">ë‹¨ìœ„ *</label>
                        <input type="text" id="edit-product-unit" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-price">íŒë§¤ ê°€ê²© (ì›) *</label>
                        <input type="number" id="edit-product-price" step="100" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-ecount-code">ì´ì¹´ìš´íŠ¸ ì œí’ˆì½”ë“œ</label>
                        <input type="text" id="edit-product-ecount-code" placeholder="ì˜ˆ: PROD001">
                        <small style="color: #666; font-size: 11px;">ì´ì¹´ìš´íŠ¸ ì—°ë™ ì‹œ í•„ìˆ˜</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-order">No (ìˆœì„œ) *</label>
                        <input type="number" id="edit-product-order" min="1" required>
                        <small style="color: #666; font-size: 11px;">ì‘ì€ ë²ˆí˜¸ê°€ ë¨¼ì € í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë ˆì‹œí”¼ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="recipe-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipe-modal-title">ì œí’ˆ ë ˆì‹œí”¼ ê´€ë¦¬</h2>
                <span class="close" onclick="closeRecipeModal()">&times;</span>
            </div>

            <div id="recipe-content">
                <h3>í˜„ì¬ ë ˆì‹œí”¼</h3>
                <div id="recipe-list" class="recipe-list"></div>

                <div class="cost-summary">
                    <strong>ì´ ì›ê°€: </strong>
                    <span id="recipe-total-cost" class="cost-summary-large">0ì›</span>
                </div>

                <div class="add-material-form">
                    <h3>ìì¬ ì¶”ê°€</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="recipe-material-select">ìì¬ ì„ íƒ</label>
                            <select id="recipe-material-select" onchange="updateRecipeUnitLabel()"></select>
                        </div>
                        <div class="form-group">
                            <label for="recipe-material-quantity">
                                ì‚¬ìš©ëŸ‰ <span id="recipe-unit-label">(ë‹¨ìœ„)</span>
                            </label>
                            <input type="number" id="recipe-material-quantity" step="0.01" placeholder="100">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-success" onclick="addMaterialToRecipe()">ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeRecipeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìì¬ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-material-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ìì¬ ìˆ˜ì •</h2>
                <span class="close" onclick="closeEditMaterialModal()">&times;</span>
            </div>
            <form id="edit-material-form">
                <input type="hidden" id="edit-material-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-material-name">ìì¬ëª… *</label>
                        <input type="text" id="edit-material-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-material-type">ìœ í˜• *</label>
                        <select id="edit-material-type" required onchange="handleEditMaterialTypeChange()">
                            <option value="ì›ìì¬">ì›ìì¬</option>
                            <option value="ë¶€ìì¬">ë¶€ìì¬</option>
                            <option value="í”„ë©">í”„ë©</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-material-weight">ìˆ˜ëŸ‰ *</label>
                        <input type="number" id="edit-material-weight" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-material-unit">ë‹¨ìœ„ *</label>
                        <select id="edit-material-unit" required onchange="handleEditUnitChange()">
                            <option value="g">g (ê·¸ë¨)</option>
                            <option value="kg">kg (í‚¬ë¡œê·¸ë¨)</option>
                            <option value="EA">EA (ê°œ)</option>
                            <option value="PK">PK (í¬ì¥)</option>
                            <option value="L">L (ë¦¬í„°)</option>
                            <option value="ml">ml (ë°€ë¦¬ë¦¬í„°)</option>
                            <option value="custom">ì§ì ‘ ì…ë ¥...</option>
                        </select>
                        <input type="text" id="edit-material-unit-custom" style="display:none; margin-top:5px;" placeholder="ë‹¨ìœ„ ì…ë ¥">
                    </div>
                    <div class="form-group" id="edit-material-price-group">
                        <label for="edit-material-price">ì…ê³  ë‹¨ê°€ (ì›) *</label>
                        <input type="number" id="edit-material-price" step="1" required>
                        <small style="color: #999; font-size: 11px; display: none;" id="edit-material-price-note">í”„ë© ìì¬ëŠ” ë ˆì‹œí”¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-material-supplier">ê³µê¸‰ì—…ì²´</label>
                    <input type="text" id="edit-material-supplier">
                </div>
                <div class="form-group">
                    <label for="edit-material-ecount-code">ì´ì¹´ìš´íŠ¸ ì œí’ˆì½”ë“œ</label>
                    <input type="text" id="edit-material-ecount-code" placeholder="ì˜ˆ: MAT001">
                    <small style="color: #666; font-size: 11px;">ì´ì¹´ìš´íŠ¸ ì—°ë™ ì‹œ í•„ìˆ˜</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
                    <button type="button" class="btn-secondary" onclick="closeEditMaterialModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìì¬ ë ˆì‹œí”¼ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="material-recipe-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="material-recipe-modal-title">ìì¬ ë ˆì‹œí”¼ ê´€ë¦¬</h2>
                <span class="close" onclick="closeMaterialRecipeModal()">&times;</span>
            </div>

            <div id="material-recipe-content">
                <h3>í˜„ì¬ ë ˆì‹œí”¼ (ì¬ë£Œ êµ¬ì„±)</h3>
                <div id="material-recipe-list" class="recipe-list"></div>

                <div class="cost-summary">
                    <strong>ì´ ì›ê°€: </strong>
                    <span id="material-recipe-total-cost" class="cost-summary-large">0ì›</span>
                </div>

                <div class="add-material-form">
                    <h3>ì¬ë£Œ ì¶”ê°€</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="material-recipe-material-select">ìì¬ ì„ íƒ</label>
                            <select id="material-recipe-material-select" onchange="updateMaterialRecipeUnitLabel()"></select>
                        </div>
                        <div class="form-group">
                            <label for="material-recipe-quantity">
                                ì‚¬ìš©ëŸ‰ <span id="material-recipe-unit-label">(ë‹¨ìœ„)</span>
                            </label>
                            <input type="number" id="material-recipe-quantity" step="0.01" placeholder="100">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-success" onclick="addIngredientToMaterialRecipe()">ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeMaterialRecipeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let currentGridData = [];
        let currentInventoryData = [];
        let currentIrregularData = [];
        let currentTargetData = [];
        let currentSalesData = [];
        let currentDonationData = [];
        let currentRecipeProductId = null;
        let allMaterials = [];
        let gridAutoSaveTimer = null;
        let inventoryAutoSaveTimer = null;
        let irregularAutoSaveTimer = null;

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        document.getElementById('grid-date').valueAsDate = new Date();
        document.getElementById('inventory-date').valueAsDate = new Date();
        document.getElementById('irregular-date').valueAsDate = new Date();
        document.getElementById('sales-date').valueAsDate = new Date();
        document.getElementById('donation-date').valueAsDate = new Date();

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => messageEl.classList.remove('show'), 3000);
        }

        // ê¸ˆì•¡ í¬ë§·
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '0';
            return Math.round(amount).toLocaleString('ko-KR');
        }

        // CSV ë‹¤ìš´ë¡œë“œ ê³µí†µ í•¨ìˆ˜
        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            // CSV í—¤ë”ì™€ ë°ì´í„° ìƒì„±
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    let value = row[header];
                    // ìˆ«ìê°€ ì•„ë‹Œ ê°’ì€ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value ?? '';
                }).join(','))
            ].join('\n');

            // BOM ì¶”ê°€ (Excelì—ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
            showMessage(`${filename} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`);
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'grid') loadGridData();
            else if (tabName === 'inventory') loadInventoryData();
            else if (tabName === 'irregular') loadIrregularData();
            else if (tabName === 'target') loadTargetData();
            else if (tabName === 'sales') loadSalesData();
            else if (tabName === 'donation') loadDonationData();
            else if (tabName === 'products') loadProducts();
            else if (tabName === 'materials') loadMaterials();
            else if (tabName === 'receipts') loadReceipts();
            else if (tabName === 'statistics') loadDashboard();
            else if (tabName === 'ecount') {
                loadEcountSettings();
                loadEcountStats();
                loadEcountLogs();
            }
        }

        // ìš”ì¼ ê³„ì‚° (0=ì¼ìš”ì¼, 6=í† ìš”ì¼)
        function isWeekend(dateString) {
            const date = new Date(dateString);
            const day = date.getDay();
            return day === 0 || day === 6; // ì¼ìš”ì¼ ë˜ëŠ” í† ìš”ì¼
        }

        // ê·¸ë¦¬ë“œ ë°ì´í„° ë¡œë“œ
        async function loadGridData() {
            const date = document.getElementById('grid-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            // ìƒì‚°ëŸ‰ ë° ëª©í‘œëŸ‰ ë°ì´í„° ë¡œë“œ
            const [productionResponse, targetResponse] = await Promise.all([
                fetch(`/api/production/grid?date=${date}`),
                fetch('/api/target-production')
            ]);

            currentGridData = await productionResponse.json();
            const targetData = await targetResponse.json();
            const tbody = document.getElementById('grid-body');

            if (currentGridData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. "ì œí’ˆ ê´€ë¦¬" íƒ­ì—ì„œ ì œí’ˆì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
                updateProductionStats();
                return;
            }

            // ìš”ì¼ì— ë”°ë¼ ëª©í‘œëŸ‰ ê²°ì •
            const weekend = isWeekend(date);

            tbody.innerHTML = currentGridData.map((item, index) => {
                // í•´ë‹¹ ì œí’ˆì˜ ëª©í‘œëŸ‰ ì°¾ê¸°
                const target = targetData.find(t => t.id === item.id);
                const targetQty = target ? (weekend ? target.weekend_target : target.weekday_target) : 0;
                const actualQty = parseFloat(item.quantity) || 0;
                const diff = actualQty - targetQty;

                return `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                    <td>${item.unit}</td>
                    <td class="price-display">${formatCurrency(item.price)}ì›</td>
                    <td class="cost-display">${formatCurrency(item.cost)}ì›</td>
                    <td style="background: #fff3cd; font-weight: 600;">${targetQty > 0 ? targetQty : ''}</td>
                    <td>
                        <input type="number" step="1" min="0" data-index="${index}"
                               value="${item.quantity || ''}" placeholder="ìƒì‚°ëŸ‰ ì…ë ¥"
                               oninput="autoSaveGrid()" onkeypress="handleKeyPress(event)">
                    </td>
                    <td style="font-weight: 600; color: ${diff >= 0 ? '#28a745' : '#dc3545'};">
                        ${actualQty > 0 ? (diff >= 0 ? '+' : '') + diff : ''}
                    </td>
                </tr>
            `;
            }).join('');

            updateProductionStats();
            const firstInput = tbody.querySelector('input[type="number"]');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const inputs = Array.from(document.querySelectorAll('#grid-body input[type="number"]'));
                const currentIndex = inputs.indexOf(event.target);
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                    inputs[currentIndex + 1].select();
                }
            }
        }

        // ì •ê¸° ì œí’ˆ ìƒì‚°ëŸ‰ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadGridData() {
            if (!currentGridData || currentGridData.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const date = document.getElementById('grid-date').value;
            const downloadData = currentGridData.map(item => ({
                'ì œí’ˆëª…': item.name,
                'ì¹´í…Œê³ ë¦¬': item.category,
                'ë‹¨ìœ„': item.unit,
                'íŒë§¤ê°€': item.price,
                'ì›ê°€': item.cost,
                'ìƒì‚°ëŸ‰': item.quantity || 0
            }));

            downloadCSV(downloadData, `ì •ê¸°ì œí’ˆ_ìƒì‚°ëŸ‰_${date}.csv`);
        }

        async function updateProductionStats() {
            document.getElementById('product-count').textContent = `ì œí’ˆ: ${currentGridData.length}ê°œ`;

            const date = document.getElementById('grid-date').value;
            if (!date) return;

            const inputs = document.querySelectorAll('#grid-body input[type="number"]');
            let filledCount = 0;
            let actualTotal = 0;
            let targetTotal = 0;

            // ëª©í‘œëŸ‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const targetResponse = await fetch('/api/target-production');
            const targetData = await targetResponse.json();
            const weekend = isWeekend(date);

            inputs.forEach((input, idx) => {
                const quantity = parseFloat(input.value) || 0;
                if (quantity > 0) filledCount++;

                const product = currentGridData[idx];
                const target = targetData.find(t => t.id === product.id);
                const targetQty = target ? (weekend ? target.weekend_target : target.weekday_target) : 0;

                actualTotal += quantity * (product.price || 0);
                targetTotal += targetQty * (product.price || 0);
            });

            const variance = actualTotal - targetTotal;
            const achievementRate = targetTotal > 0 ? (actualTotal / targetTotal * 100) : 0;

            document.getElementById('filled-count').textContent = `ì…ë ¥ë¨: ${filledCount}ê°œ`;
            document.getElementById('actual-amount').textContent = formatCurrency(actualTotal) + 'ì›';
            document.getElementById('target-amount').textContent = formatCurrency(targetTotal) + 'ì›';
            document.getElementById('variance-amount').textContent =
                (variance >= 0 ? '+' : '') + formatCurrency(variance) + 'ì›';
            document.getElementById('variance-amount').style.color = variance >= 0 ? '#28a745' : '#dc3545';
            document.getElementById('achievement-rate').textContent = achievementRate.toFixed(1) + '%';
            document.getElementById('achievement-rate').style.color =
                achievementRate >= 100 ? '#28a745' : achievementRate >= 80 ? '#ffc107' : '#dc3545';
        }

        async function saveGridData() {
            const date = document.getElementById('grid-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const inputs = document.querySelectorAll('#grid-body input[type="number"]');
            const products = [];
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                products.push({ product_id: currentGridData[index].id, quantity: input.value });
            });

            const response = await fetch('/api/production/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date, products: products })
            });

            const result = await response.json();
            if (result.success) showMessage('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            else showMessage('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
        }

        // ì¬ê³  ë°ì´í„° ë¡œë“œ
        async function loadInventoryData() {
            const date = document.getElementById('inventory-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const response = await fetch(`/api/inventory/grid?date=${date}`);
            currentInventoryData = await response.json();
            const tbody = document.getElementById('inventory-body');

            if (currentInventoryData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. "ì œí’ˆ ê´€ë¦¬" íƒ­ì—ì„œ ì œí’ˆì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
                updateInventoryStats();
                return;
            }

            tbody.innerHTML = currentInventoryData.map((item, index) => {
                const stockType = item.stock_type || 'ì¼ë°˜';
                const stockLabel = stockType === 'ì¼ë°˜' ? 'ì¼ë°˜ (ê¸°ë¶€)' : 'íŠ¹ìˆ˜ (ì¬ì‚¬ìš©)';
                return `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                    <td><span class="stock-badge stock-${stockType}">${stockLabel}</span></td>
                    <td>${item.unit}</td>
                    <td class="price-display">${formatCurrency(item.price)}ì›</td>
                    <td class="cost-display">${formatCurrency(item.cost)}ì›</td>
                    <td>
                        <input type="number" step="1" min="0" data-index="${index}"
                               value="${item.quantity || ''}" placeholder="ì¬ê³ ëŸ‰ ì…ë ¥"
                               oninput="autoSaveInventory()" onkeypress="handleKeyPress(event)">
                    </td>
                </tr>
            `;
            }).join('');

            updateInventoryStats();
            const firstInput = tbody.querySelector('input[type="number"]');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        // ì¬ê³  ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadInventoryData() {
            if (!currentInventoryData || currentInventoryData.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const date = document.getElementById('inventory-date').value;
            const downloadData = currentInventoryData.map(item => ({
                'ì œí’ˆëª…': item.name,
                'ì¹´í…Œê³ ë¦¬': item.category,
                'ì¬ê³ ì²˜ë¦¬': item.stock_type === 'ì¼ë°˜' ? 'ì¼ë°˜(ê¸°ë¶€)' : 'íŠ¹ìˆ˜(ì¬ì‚¬ìš©)',
                'ë‹¨ìœ„': item.unit,
                'íŒë§¤ê°€': item.price,
                'ì›ê°€': item.cost,
                'ì¬ê³ ëŸ‰': item.quantity || 0
            }));

            downloadCSV(downloadData, `ì¬ê³ _${date}.csv`);
        }

        // ì¬ê³  í†µê³„ ì—…ë°ì´íŠ¸
        function updateInventoryStats() {
            document.getElementById('inventory-product-count').textContent = `ì œí’ˆ: ${currentInventoryData.length}ê°œ`;

            const inputs = document.querySelectorAll('#inventory-body input[type="number"]');
            let filledCount = 0;
            let totalValue = 0;
            let normalValue = 0;
            let specialValue = 0;

            inputs.forEach((input, idx) => {
                const quantity = parseFloat(input.value) || 0;
                if (quantity > 0) {
                    filledCount++;
                }

                const product = currentInventoryData[idx];
                const itemValue = quantity * (product.price || 0);
                totalValue += itemValue;

                // ì¬ê³  ì²˜ë¦¬ ë°©ì‹ì— ë”°ë¼ ë¶„ë¥˜
                const stockType = product.stock_type || 'ì¼ë°˜';
                if (stockType === 'ì¼ë°˜') {
                    normalValue += itemValue;
                } else if (stockType === 'íŠ¹ìˆ˜') {
                    specialValue += itemValue;
                }
            });

            document.getElementById('inventory-filled-count').textContent = `ì…ë ¥ë¨: ${filledCount}ê°œ`;
            document.getElementById('inventory-total-value').textContent = formatCurrency(totalValue) + 'ì›';
            document.getElementById('inventory-normal-value').textContent = formatCurrency(normalValue) + 'ì›';
            document.getElementById('inventory-special-value').textContent = formatCurrency(specialValue) + 'ì›';
        }

        // ì¬ê³  ë°ì´í„° ì €ì¥
        async function saveInventoryData() {
            const date = document.getElementById('inventory-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const inputs = document.querySelectorAll('#inventory-body input[type="number"]');
            const products = [];
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                products.push({ product_id: currentInventoryData[index].id, quantity: input.value });
            });

            const response = await fetch('/api/inventory/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date, products: products })
            });

            const result = await response.json();
            if (result.success) showMessage('âœ… ì¬ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            else showMessage('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
        }

        // ìƒì‚°ëŸ‰ ìë™ ì €ì¥ (ë””ë°”ìš´ì‹±)
        function autoSaveGrid() {
            updateProductionStats();
            clearTimeout(gridAutoSaveTimer);
            gridAutoSaveTimer = setTimeout(async () => {
                await saveGridData();
            }, 1000); // 1ì´ˆ í›„ ìë™ ì €ì¥
        }

        // ì¬ê³  ìë™ ì €ì¥ (ë””ë°”ìš´ì‹±)
        function autoSaveInventory() {
            updateInventoryStats();
            clearTimeout(inventoryAutoSaveTimer);
            inventoryAutoSaveTimer = setTimeout(async () => {
                await saveInventoryData();
            }, 1000); // 1ì´ˆ í›„ ìë™ ì €ì¥
        }

        // ========== ë¹„ì •ê¸° ì œí’ˆ ê´€ë¦¬ ==========

        async function loadIrregularData() {
            const date = document.getElementById('irregular-date').value;
            if (!date) {
                showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            const response = await fetch(`/api/irregular-product/grid?date=${date}`);
            currentIrregularData = await response.json();

            const tbody = document.getElementById('irregular-body');

            if (currentIrregularData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">ë¹„ì •ê¸° ì œí’ˆ ì¹´í…Œê³ ë¦¬ì— ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = currentIrregularData.map((item, index) => {
                const prevClosing = item.prev_closing_inventory || 0;
                // ê¸°ì¡´ ê¸°ì´ˆì¬ê³ ê°€ ì—†ìœ¼ë©´ ì „ë‚  ê¸°ë§ì¬ê³ ë¡œ ìë™ ì±„ì›€
                const opening = item.opening_inventory || (item.opening_inventory === 0 ? 0 : prevClosing);
                const production = item.production || '';
                const donation = item.donation || '';
                const closing = item.closing_inventory || '';
                const sales = calculateSales(opening, production, donation, closing);
                const variance = prevClosing - (parseFloat(opening) || 0);
                const varianceStyle = variance !== 0 ? 'color: #dc3545; font-weight: 600;' : 'color: #28a745;';

                return `
                    <tr>
                        <td style="font-weight: 600;">${item.name}</td>
                        <td>${item.unit}</td>
                        <td class="price-display">${Number(item.price || 0).toLocaleString()}ì›</td>
                        <td style="background: #f0f0f0; font-weight: 600; color: #666;">${prevClosing || '-'}</td>
                        <td>
                            <input type="number" step="1" min="0" data-index="${index}" data-field="opening"
                                   value="${opening}" placeholder="ê¸°ì´ˆì¬ê³ "
                                   oninput="autoSaveIrregular()" onkeypress="handleKeyPress(event)">
                        </td>
                        <td style="${varianceStyle}">${variance !== 0 ? variance : '-'}</td>
                        <td>
                            <input type="number" step="1" min="0" data-index="${index}" data-field="production"
                                   value="${production}" placeholder="ìƒì‚°ëŸ‰"
                                   oninput="autoSaveIrregular()" onkeypress="handleKeyPress(event)">
                        </td>
                        <td>
                            <input type="number" step="1" min="0" data-index="${index}" data-field="donation"
                                   value="${donation}" placeholder="ê¸°ë¶€ëŸ‰"
                                   oninput="autoSaveIrregular()" onkeypress="handleKeyPress(event)">
                        </td>
                        <td>
                            <input type="number" step="1" min="0" data-index="${index}" data-field="closing"
                                   value="${closing}" placeholder="ê¸°ë§ì¬ê³ "
                                   oninput="autoSaveIrregular()" onkeypress="handleKeyPress(event)">
                        </td>
                        <td style="font-weight: 600; color: #667eea;">${sales}</td>
                    </tr>
                `;
            }).join('');

            updateIrregularStats();
        }

        function calculateSales(opening, production, donation, closing) {
            const o = parseFloat(opening) || 0;
            const p = parseFloat(production) || 0;
            const d = parseFloat(donation) || 0;
            const c = parseFloat(closing) || 0;
            const sales = o + p - d - c;
            return sales > 0 ? sales : 0;
        }

        // ë¹„ì •ê¸° ì œí’ˆ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadIrregularData() {
            if (!currentIrregularData || currentIrregularData.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const date = document.getElementById('irregular-date').value;
            const downloadData = currentIrregularData.map(item => {
                const opening = item.opening_inventory || (item.prev_closing_inventory || 0);
                const production = item.production || 0;
                const donation = item.donation || 0;
                const closing = item.closing_inventory || 0;
                const sales = calculateSales(opening, production, donation, closing);

                return {
                    'ì œí’ˆëª…': item.name,
                    'ë‹¨ìœ„': item.unit,
                    'íŒë§¤ê°€': item.price,
                    'ì „ë‚ ê¸°ë§ì¬ê³ ': item.prev_closing_inventory || 0,
                    'ê¸°ì´ˆì¬ê³ ': opening,
                    'ìƒì‚°ëŸ‰': production,
                    'ê¸°ë¶€ëŸ‰': donation,
                    'ê¸°ë§ì¬ê³ ': closing,
                    'íŒë§¤ëŸ‰': sales
                };
            });

            downloadCSV(downloadData, `ë¹„ì •ê¸°ì œí’ˆ_${date}.csv`);
        }

        function updateIrregularStats() {
            const tbody = document.getElementById('irregular-body');
            const inputs = tbody.querySelectorAll('input[type="number"]');

            let filledCount = 0;
            let totalSales = 0;
            let totalRevenue = 0;

            // ê° ì œí’ˆì˜ 4ê°œ í•„ë“œë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì²´í¬
            const productCount = currentIrregularData.length;
            for (let i = 0; i < productCount; i++) {
                const openingInput = tbody.querySelector(`input[data-index="${i}"][data-field="opening"]`);
                const productionInput = tbody.querySelector(`input[data-index="${i}"][data-field="production"]`);
                const donationInput = tbody.querySelector(`input[data-index="${i}"][data-field="donation"]`);
                const closingInput = tbody.querySelector(`input[data-index="${i}"][data-field="closing"]`);

                const opening = parseFloat(openingInput?.value) || 0;
                const production = parseFloat(productionInput?.value) || 0;
                const donation = parseFloat(donationInput?.value) || 0;
                const closing = parseFloat(closingInput?.value) || 0;

                // í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´ ì¹´ìš´íŠ¸
                if (opening > 0 || production > 0 || donation > 0 || closing > 0) {
                    filledCount++;
                }

                const sales = calculateSales(opening, production, donation, closing);
                totalSales += sales;

                const product = currentIrregularData[i];
                totalRevenue += sales * (product.price || 0);

                const row = openingInput?.closest('tr');
                if (row) {
                    const cells = row.querySelectorAll('td');

                    // ì˜¤ì°¨ ì…€ ì—…ë°ì´íŠ¸ (6ë²ˆì§¸ ì…€, 0-based indexë¡œ 5)
                    const prevClosing = product.prev_closing_inventory || 0;
                    const variance = prevClosing - opening;
                    const varianceCell = cells[5];
                    if (varianceCell) {
                        varianceCell.textContent = variance !== 0 ? variance : '-';
                        varianceCell.style.color = variance !== 0 ? '#dc3545' : '#28a745';
                        varianceCell.style.fontWeight = variance !== 0 ? '600' : 'normal';
                    }

                    // íŒë§¤ëŸ‰ ì…€ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì…€)
                    const salesCell = cells[cells.length - 1];
                    if (salesCell) {
                        salesCell.textContent = sales;
                    }
                }
            }

            document.getElementById('irregular-product-count').textContent = `ì œí’ˆ: ${productCount}ê°œ`;
            document.getElementById('irregular-filled-count').textContent = `ì…ë ¥ë¨: ${filledCount}ê°œ`;
            document.getElementById('irregular-total-sales').textContent = `${totalSales.toLocaleString()}ê°œ`;
            document.getElementById('irregular-total-revenue').textContent = `${Math.round(totalRevenue).toLocaleString()}ì›`;
        }

        async function saveIrregularData() {
            const date = document.getElementById('irregular-date').value;
            if (!date) return;

            const tbody = document.getElementById('irregular-body');
            const products = [];

            currentIrregularData.forEach((item, index) => {
                const openingInput = tbody.querySelector(`input[data-index="${index}"][data-field="opening"]`);
                const productionInput = tbody.querySelector(`input[data-index="${index}"][data-field="production"]`);
                const donationInput = tbody.querySelector(`input[data-index="${index}"][data-field="donation"]`);
                const closingInput = tbody.querySelector(`input[data-index="${index}"][data-field="closing"]`);

                products.push({
                    product_id: item.id,
                    opening_inventory: openingInput?.value || 0,
                    production: productionInput?.value || 0,
                    donation: donationInput?.value || 0,
                    closing_inventory: closingInput?.value || 0,
                    record_id: item.record_id
                });
            });

            try {
                const response = await fetch('/api/irregular-product/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, products })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    showMessage('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        function autoSaveIrregular() {
            updateIrregularStats();
            clearTimeout(irregularAutoSaveTimer);
            irregularAutoSaveTimer = setTimeout(async () => {
                await saveIrregularData();
            }, 1000); // 1ì´ˆ í›„ ìë™ ì €ì¥
        }

        // ========== íŒë§¤ ë°ì´í„° ê´€ë¦¬ ==========

        async function loadSalesData() {
            const date = document.getElementById('sales-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const response = await fetch(`/api/sales/grid?date=${date}`);
            currentSalesData = await response.json();

            // ì •ê¸° ì œí’ˆê³¼ ë¹„ì •ê¸° ì œí’ˆ ë¶„ë¦¬
            const regularProducts = currentSalesData.filter(item => item.category !== 'ë¹„ì •ê¸° ì œí’ˆ');
            const irregularProducts = currentSalesData.filter(item => item.category === 'ë¹„ì •ê¸° ì œí’ˆ');

            const regularTbody = document.getElementById('sales-regular-body');
            const irregularTbody = document.getElementById('sales-irregular-body');

            // ì •ê¸° ì œí’ˆ ë Œë”ë§
            if (regularProducts.length === 0) {
                regularTbody.innerHTML = '<tr><td colspan="10" class="empty-state">ì •ê¸° ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                regularTbody.innerHTML = regularProducts.map((item) => {
                    const sales = item.sales || 0;
                    const revenue = sales * (item.price || 0);
                    const cost = sales * (item.cost || 0);
                    const margin = revenue - cost;

                    return `
                    <tr>
                        <td>${item.name}</td>
                        <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                        <td>${item.unit}</td>
                        <td class="price-display">${formatCurrency(item.price)}ì›</td>
                        <td class="cost-display">${formatCurrency(item.cost)}ì›</td>
                        <td>${item.production || 0}</td>
                        <td>${item.closing_inventory || 0}</td>
                        <td style="background: #fff3cd; font-weight: 600; color: #000;">${sales}</td>
                        <td class="price-display">${formatCurrency(revenue)}ì›</td>
                        <td class="profit-display">${formatCurrency(margin)}ì›</td>
                    </tr>
                `;
                }).join('');
            }

            // ë¹„ì •ê¸° ì œí’ˆ ë Œë”ë§
            if (irregularProducts.length === 0) {
                irregularTbody.innerHTML = '<tr><td colspan="12" class="empty-state">ë¹„ì •ê¸° ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                irregularTbody.innerHTML = irregularProducts.map((item) => {
                    const sales = item.sales || 0;
                    const revenue = sales * (item.price || 0);
                    const cost = sales * (item.cost || 0);
                    const margin = revenue - cost;

                    return `
                    <tr>
                        <td>${item.name}</td>
                        <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                        <td>${item.unit}</td>
                        <td class="price-display">${formatCurrency(item.price)}ì›</td>
                        <td class="cost-display">${formatCurrency(item.cost)}ì›</td>
                        <td>${item.opening_inventory || 0}</td>
                        <td>${item.production || 0}</td>
                        <td>${item.donation || 0}</td>
                        <td>${item.closing_inventory || 0}</td>
                        <td style="background: #fff3cd; font-weight: 600; color: #000;">${sales}</td>
                        <td class="price-display">${formatCurrency(revenue)}ì›</td>
                        <td class="profit-display">${formatCurrency(margin)}ì›</td>
                    </tr>
                `;
                }).join('');
            }

            updateSalesStats();
        }

        // íŒë§¤ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadSalesData() {
            if (!currentSalesData || currentSalesData.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const date = document.getElementById('sales-date').value;
            const downloadData = currentSalesData.map(item => {
                const sales = item.sales || 0;
                const revenue = sales * (item.price || 0);
                const cost = sales * (item.cost || 0);
                const margin = revenue - cost;

                const data = {
                    'ì œí’ˆëª…': item.name,
                    'ì¹´í…Œê³ ë¦¬': item.category,
                    'ë‹¨ìœ„': item.unit,
                    'íŒë§¤ê°€': item.price,
                    'ì›ê°€': item.cost
                };

                if (item.category === 'ë¹„ì •ê¸° ì œí’ˆ') {
                    data['ê¸°ì´ˆì¬ê³ '] = item.opening_inventory || 0;
                    data['ìƒì‚°ëŸ‰'] = item.production || 0;
                    data['ê¸°ë¶€ëŸ‰'] = item.donation || 0;
                    data['ê¸°ë§ì¬ê³ '] = item.closing_inventory || 0;
                } else {
                    data['ìƒì‚°ëŸ‰'] = item.production || 0;
                    data['ê¸°ë§ì¬ê³ '] = item.closing_inventory || 0;
                }

                data['íŒë§¤ëŸ‰'] = sales;
                data['íŒë§¤ê¸ˆì•¡'] = revenue;
                data['ë§ˆì§„'] = margin;

                return data;
            });

            downloadCSV(downloadData, `íŒë§¤_${date}.csv`);
        }

        // íŒë§¤ í†µê³„ ì—…ë°ì´íŠ¸
        function updateSalesStats() {
            const regularProducts = currentSalesData.filter(item => item.category !== 'ë¹„ì •ê¸° ì œí’ˆ');
            const irregularProducts = currentSalesData.filter(item => item.category === 'ë¹„ì •ê¸° ì œí’ˆ');

            document.getElementById('sales-product-count').textContent = `ì œí’ˆ: ${currentSalesData.length}ê°œ (ì •ê¸°: ${regularProducts.length}, ë¹„ì •ê¸°: ${irregularProducts.length})`;

            // ì •ê¸° ì œí’ˆ íŒë§¤ê¸ˆì•¡
            let regularRevenue = 0;
            regularProducts.forEach((item) => {
                const sales = item.sales || 0;
                regularRevenue += sales * (item.price || 0);
            });

            // ë¹„ì •ê¸° ì œí’ˆ íŒë§¤ê¸ˆì•¡
            let irregularRevenue = 0;
            irregularProducts.forEach((item) => {
                const sales = item.sales || 0;
                irregularRevenue += sales * (item.price || 0);
            });

            const totalRevenue = regularRevenue + irregularRevenue;

            document.getElementById('sales-regular-revenue').textContent = `${formatCurrency(regularRevenue)}ì›`;
            document.getElementById('sales-irregular-revenue').textContent = `${formatCurrency(irregularRevenue)}ì›`;
            document.getElementById('sales-total-revenue').textContent = `${formatCurrency(totalRevenue)}ì›`;
        }

        // ========== ê¸°ë¶€ ë°ì´í„° ê´€ë¦¬ ==========

        async function loadDonationData() {
            const date = document.getElementById('donation-date').value;
            if (!date) { showMessage('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const response = await fetch(`/api/donation/grid?date=${date}`);
            currentDonationData = await response.json();
            const tbody = document.getElementById('donation-body');

            if (currentDonationData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ê¸°ë¶€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                updateDonationStats();
                return;
            }

            tbody.innerHTML = currentDonationData.map((item) => {
                const donationAmount = (item.donation_quantity || 0) * (item.price || 0);

                return `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                    <td><span class="category-badge category-${item.product_type}">${item.product_type}</span></td>
                    <td>${item.unit}</td>
                    <td class="price-display">${formatCurrency(item.price)}ì›</td>
                    <td style="background: #c8e6c9; font-weight: 600; color: #000;">${item.donation_quantity || 0}</td>
                    <td class="price-display">${formatCurrency(donationAmount)}ì›</td>
                </tr>
            `;
            }).join('');

            updateDonationStats();
        }

        // ê¸°ë¶€ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadDonationData() {
            if (!currentDonationData || currentDonationData.length === 0) {
                showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const date = document.getElementById('donation-date').value;
            const downloadData = currentDonationData.map(item => ({
                'ì œí’ˆëª…': item.name,
                'ì¹´í…Œê³ ë¦¬': item.category,
                'ì œí’ˆêµ¬ë¶„': item.product_type,
                'ë‹¨ìœ„': item.unit,
                'íŒë§¤ê°€': item.price,
                'ê¸°ë¶€ëŸ‰': item.donation_quantity || 0,
                'ê¸°ë¶€ê¸ˆì•¡': (item.donation_quantity || 0) * (item.price || 0)
            }));

            downloadCSV(downloadData, `ê¸°ë¶€_${date}.csv`);
        }

        // ê¸°ë¶€ í†µê³„ ì—…ë°ì´íŠ¸
        function updateDonationStats() {
            document.getElementById('donation-product-count').textContent = `ì œí’ˆ: ${currentDonationData.length}ê°œ`;

            let totalQuantity = 0;
            let totalAmount = 0;

            currentDonationData.forEach((item) => {
                const quantity = item.donation_quantity || 0;
                const amount = quantity * (item.price || 0);
                totalQuantity += quantity;
                totalAmount += amount;
            });

            document.getElementById('donation-total-quantity').textContent = `${totalQuantity.toLocaleString()}ê°œ`;
            document.getElementById('donation-total-amount').textContent = `${formatCurrency(totalAmount)}ì›`;
        }

        // ëª©í‘œ ìƒì‚°ëŸ‰ ë¡œë“œ
        async function loadTargetData() {
            const response = await fetch('/api/target-production');
            currentTargetData = await response.json();
            const tbody = document.getElementById('target-body');

            if (currentTargetData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. "ì œí’ˆ ê´€ë¦¬" íƒ­ì—ì„œ ì œí’ˆì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.</td></tr>';
                updateTargetStats();
                return;
            }

            tbody.innerHTML = currentTargetData.map((item, index) => `
                <tr>
                    <td>${item.name}</td>
                    <td><span class="category-badge category-${item.category || 'ê¸°íƒ€'}">${item.category || 'ê¸°íƒ€'}</span></td>
                    <td>${item.unit}</td>
                    <td class="price-display">${formatCurrency(item.price)}ì›</td>
                    <td>
                        <input type="number" step="1" min="0" data-index="${index}" data-field="weekday"
                               value="${item.weekday_target || ''}" placeholder="í‰ì¼ ëª©í‘œëŸ‰"
                               onchange="updateTargetStats()" onkeypress="handleKeyPress(event)">
                    </td>
                    <td>
                        <input type="number" step="1" min="0" data-index="${index}" data-field="weekend"
                               value="${item.weekend_target || ''}" placeholder="ì£¼ë§ ëª©í‘œëŸ‰"
                               onchange="updateTargetStats()" onkeypress="handleKeyPress(event)">
                    </td>
                </tr>
            `).join('');

            updateTargetStats();
        }

        // ëª©í‘œ ìƒì‚°ëŸ‰ í†µê³„ ì—…ë°ì´íŠ¸
        function updateTargetStats() {
            let weekdayAmount = 0;
            let weekdayCost = 0;
            let weekendAmount = 0;
            let weekendCost = 0;

            currentTargetData.forEach((item, index) => {
                const weekdayInput = document.querySelector(`#target-body input[data-index="${index}"][data-field="weekday"]`);
                const weekendInput = document.querySelector(`#target-body input[data-index="${index}"][data-field="weekend"]`);

                const weekdayQty = parseFloat(weekdayInput?.value) || 0;
                const weekendQty = parseFloat(weekendInput?.value) || 0;

                weekdayAmount += weekdayQty * (item.price || 0);
                weekdayCost += weekdayQty * (item.cost || 0);
                weekendAmount += weekendQty * (item.price || 0);
                weekendCost += weekendQty * (item.cost || 0);
            });

            const weekdayProfit = weekdayAmount - weekdayCost;
            const weekendProfit = weekendAmount - weekendCost;

            document.getElementById('weekday-target-amount').textContent = formatCurrency(weekdayAmount) + 'ì›';
            document.getElementById('weekday-target-cost').textContent = formatCurrency(weekdayCost) + 'ì›';
            document.getElementById('weekday-target-profit').textContent = formatCurrency(weekdayProfit) + 'ì›';
            document.getElementById('weekend-target-amount').textContent = formatCurrency(weekendAmount) + 'ì›';
            document.getElementById('weekend-target-cost').textContent = formatCurrency(weekendCost) + 'ì›';
            document.getElementById('weekend-target-profit').textContent = formatCurrency(weekendProfit) + 'ì›';
        }

        // ëª©í‘œ ìƒì‚°ëŸ‰ ì €ì¥
        async function saveTargetData() {
            const inputs = document.querySelectorAll('#target-body input[type="number"]');
            const targets = [];

            currentTargetData.forEach((item, index) => {
                const weekdayInput = document.querySelector(`#target-body input[data-index="${index}"][data-field="weekday"]`);
                const weekendInput = document.querySelector(`#target-body input[data-index="${index}"][data-field="weekend"]`);

                targets.push({
                    product_id: item.id,
                    weekday_target: weekdayInput ? (weekdayInput.value || 0) : 0,
                    weekend_target: weekendInput ? (weekendInput.value || 0) : 0
                });
            });

            const response = await fetch('/api/target-production/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targets: targets })
            });

            const result = await response.json();
            if (result.success) {
                showMessage('âœ… ëª©í‘œ ìƒì‚°ëŸ‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadTargetData();
            } else {
                showMessage('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
            }
        }

        // ì „ì²´ ì œí’ˆ ë°ì´í„° ì €ì¥
        let allProducts = [];

        // ì œí’ˆ ëª©ë¡ ë¡œë“œ
        async function loadProducts() {
            const response = await fetch('/api/products');
            allProducts = await response.json();
            renderProducts(allProducts);
        }

        // ì œí’ˆ ëª©ë¡ ë Œë”ë§
        function renderProducts(products) {
            const tbody = document.querySelector('#products-table tbody');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = products.map((p) => {
                const costRate = p.price > 0 ? ((p.cost / p.price) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td style="text-align: center; font-weight: 600; color: #667eea;">${p.display_order || 999}</td>
                        <td>${p.name}</td>
                        <td><span class="category-badge category-${p.category}">${p.category}</span></td>
                        <td><span class="stock-badge stock-${p.stock_type}">${p.stock_type}</span></td>
                        <td>${p.unit}</td>
                        <td class="price-display">${formatCurrency(p.price)}ì›</td>
                        <td class="cost-display">${formatCurrency(p.cost)}ì›</td>
                        <td class="profit-display">${costRate}%</td>
                        <td>
                            <div class="actions">
                                <button class="btn-recipe" onclick="openRecipeModal(${p.id}, '${p.name}')">ë ˆì‹œí”¼</button>
                                <button class="btn-edit" onclick="editProduct(${p.id})">ìˆ˜ì •</button>
                                <button class="btn-danger" onclick="deleteProduct(${p.id})">ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ì œí’ˆ í•„í„°ë§
        function filterProducts() {
            const searchText = document.getElementById('product-search').value.toLowerCase();
            const categoryFilter = document.getElementById('product-category-filter').value;
            const stockFilter = document.getElementById('product-stock-filter').value;

            const filtered = allProducts.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchText);
                const matchesCategory = !categoryFilter || p.category === categoryFilter;
                const matchesStock = !stockFilter || p.stock_type === stockFilter;
                return matchesSearch && matchesCategory && matchesStock;
            });

            renderProducts(filtered);
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetProductFilter() {
            document.getElementById('product-search').value = '';
            document.getElementById('product-category-filter').value = '';
            document.getElementById('product-stock-filter').value = '';
            renderProducts(allProducts);
        }

        // ì œí’ˆ ì¶”ê°€
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('product-name').value,
                unit: document.getElementById('product-unit').value,
                price: document.getElementById('product-price').value,
                cost: 0,
                stock_type: document.getElementById('product-stock-type').value,
                category: document.getElementById('product-category').value,
                ecount_code: document.getElementById('product-ecount-code').value || null,
                display_order: document.getElementById('product-order').value || 999
            };

            const response = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ì œí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                e.target.reset();
                loadProducts();
            } else {
                showMessage(result.error || 'ì œí’ˆ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        });

        // ì œí’ˆ ìˆ˜ì • ëª¨ë‹¬
        async function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) {
                const response = await fetch('/api/products');
                allProducts = await response.json();
                const product = allProducts.find(p => p.id === id);
                if (!product) return;
            }

            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-unit').value = product.unit;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-stock-type').value = product.stock_type;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-ecount-code').value = product.ecount_code || '';
            document.getElementById('edit-product-order').value = product.display_order || 999;
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const data = {
                name: document.getElementById('edit-product-name').value,
                unit: document.getElementById('edit-product-unit').value,
                price: document.getElementById('edit-product-price').value,
                cost: 0,
                stock_type: document.getElementById('edit-product-stock-type').value,
                category: document.getElementById('edit-product-category').value,
                ecount_code: document.getElementById('edit-product-ecount-code').value || null,
                display_order: document.getElementById('edit-product-order').value || 999
            };

            const response = await fetch(`/api/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ì œí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeEditModal();
                loadProducts();
            } else {
                showMessage(result.error || 'ì œí’ˆ ìˆ˜ì • ì‹¤íŒ¨', 'error');
            }
        });

        async function deleteProduct(id) {
            if (!confirm('ì´ ì œí’ˆê³¼ ê´€ë ¨ëœ ëª¨ë“  ìƒì‚°ëŸ‰ ê¸°ë¡ ë° ë ˆì‹œí”¼ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                showMessage('ì œí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadProducts();
            }
        }

        // ìì¬ ìœ í˜• ë³€ê²½ ì²˜ë¦¬ (ì¶”ê°€ í¼)
        function handleMaterialTypeChange() {
            const type = document.getElementById('material-type').value;
            const priceInput = document.getElementById('material-price');
            const priceNote = document.getElementById('material-price-note');

            if (type === 'í”„ë©') {
                priceInput.disabled = true;
                priceInput.required = false;
                priceInput.value = '';
                priceInput.placeholder = 'ë ˆì‹œí”¼ì—ì„œ ìë™ ê³„ì‚°';
                priceNote.style.display = 'block';
            } else {
                priceInput.disabled = false;
                priceInput.required = true;
                priceInput.placeholder = '5000';
                priceNote.style.display = 'none';
            }
        }

        // ë‹¨ìœ„ ì„ íƒ ì²˜ë¦¬ (ì¶”ê°€ í¼)
        function handleUnitChange() {
            const select = document.getElementById('material-unit');
            const customInput = document.getElementById('material-unit-custom');
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // ìì¬ ìœ í˜• ë³€ê²½ ì²˜ë¦¬ (ìˆ˜ì • í¼)
        function handleEditMaterialTypeChange() {
            const type = document.getElementById('edit-material-type').value;
            const priceInput = document.getElementById('edit-material-price');
            const priceNote = document.getElementById('edit-material-price-note');

            if (type === 'í”„ë©') {
                priceInput.disabled = true;
                priceInput.required = false;
                priceInput.value = '';
                priceInput.placeholder = 'ë ˆì‹œí”¼ì—ì„œ ìë™ ê³„ì‚°';
                priceNote.style.display = 'block';
            } else {
                priceInput.disabled = false;
                priceInput.required = true;
                priceInput.placeholder = 'ì…ê³  ë‹¨ê°€ ì…ë ¥';
                priceNote.style.display = 'none';
            }
        }

        // ë‹¨ìœ„ ì„ íƒ ì²˜ë¦¬ (ìˆ˜ì • í¼)
        function handleEditUnitChange() {
            const select = document.getElementById('edit-material-unit');
            const customInput = document.getElementById('edit-material-unit-custom');
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // ìì¬ ê´€ë¦¬
        async function loadMaterials() {
            const response = await fetch('/api/materials');
            allMaterials = await response.json();
            const tbody = document.querySelector('#materials-table tbody');

            if (allMaterials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">ë“±ë¡ëœ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = allMaterials.map(m => {
                const pricePerUnit = m.price_per_unit || m.price_per_gram || 0;
                return `
                    <tr>
                        <td>${m.name}</td>
                        <td><span class="type-${m.type}">${m.type}</span></td>
                        <td>${formatCurrency(m.weight)}</td>
                        <td>${m.unit}</td>
                        <td class="cost-display">${formatCurrency(m.purchase_price)}ì›</td>
                        <td class="price-display">${pricePerUnit.toFixed(2)}ì›/${m.unit}</td>
                        <td>${m.supplier || '-'}</td>
                        <td>
                            <div class="actions">
                                ${m.type === 'í”„ë©' ? `<button class="btn-recipe" onclick="openMaterialRecipeModal(${m.id}, '${m.name}')">ë ˆì‹œí”¼</button>` : ''}
                                <button class="btn-edit" onclick="editMaterial(${m.id})">ìˆ˜ì •</button>
                                <button class="btn-danger" onclick="deleteMaterial(${m.id})">ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('material-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const unitSelect = document.getElementById('material-unit');
            let unit = unitSelect.value;
            if (unit === 'custom') {
                unit = document.getElementById('material-unit-custom').value.trim();
                if (!unit) {
                    showMessage('ë‹¨ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }
            }

            const type = document.getElementById('material-type').value;
            const data = {
                name: document.getElementById('material-name').value,
                type: type,
                weight: document.getElementById('material-weight').value,
                unit: unit,
                purchase_price: type === 'í”„ë©' ? 0 : document.getElementById('material-price').value,
                supplier: document.getElementById('material-supplier').value,
                ecount_code: document.getElementById('material-ecount-code').value || null
            };

            const response = await fetch('/api/materials', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ìì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                e.target.reset();
                document.getElementById('material-unit').value = 'g';
                handleUnitChange();
                loadMaterials();
            } else {
                showMessage(result.error || 'ìì¬ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        });

        async function editMaterial(id) {
            const material = allMaterials.find(m => m.id === id);
            if (!material) return;

            document.getElementById('edit-material-id').value = material.id;
            document.getElementById('edit-material-name').value = material.name;
            document.getElementById('edit-material-type').value = material.type;
            document.getElementById('edit-material-weight').value = material.weight;
            document.getElementById('edit-material-price').value = material.purchase_price;
            document.getElementById('edit-material-supplier').value = material.supplier || '';
            document.getElementById('edit-material-ecount-code').value = material.ecount_code || '';

            // ë‹¨ìœ„ ì„¤ì •
            const unitSelect = document.getElementById('edit-material-unit');
            const customInput = document.getElementById('edit-material-unit-custom');
            const standardUnits = ['g', 'kg', 'EA', 'PK', 'L', 'ml'];

            if (standardUnits.includes(material.unit)) {
                unitSelect.value = material.unit;
                customInput.style.display = 'none';
            } else {
                unitSelect.value = 'custom';
                customInput.value = material.unit;
                customInput.style.display = 'block';
            }

            // í”„ë© ìì¬ë©´ ì…ê³  ë‹¨ê°€ í•„ë“œ ë¹„í™œì„±í™”
            handleEditMaterialTypeChange();

            document.getElementById('edit-material-modal').style.display = 'block';
        }

        function closeEditMaterialModal() {
            document.getElementById('edit-material-modal').style.display = 'none';
        }

        document.getElementById('edit-material-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const unitSelect = document.getElementById('edit-material-unit');
            let unit = unitSelect.value;
            if (unit === 'custom') {
                unit = document.getElementById('edit-material-unit-custom').value.trim();
                if (!unit) {
                    showMessage('ë‹¨ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }
            }

            const id = document.getElementById('edit-material-id').value;
            const type = document.getElementById('edit-material-type').value;
            const data = {
                name: document.getElementById('edit-material-name').value,
                type: type,
                weight: document.getElementById('edit-material-weight').value,
                unit: unit,
                purchase_price: type === 'í”„ë©' ? 0 : document.getElementById('edit-material-price').value,
                supplier: document.getElementById('edit-material-supplier').value,
                ecount_code: document.getElementById('edit-material-ecount-code').value || null
            };

            const response = await fetch(`/api/materials/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ìì¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ì—°ê´€ëœ ì œí’ˆì˜ ì›ê°€ê°€ ìë™ìœ¼ë¡œ ì¬ê³„ì‚°ë©ë‹ˆë‹¤.');
                closeEditMaterialModal();
                loadMaterials();
                loadProducts(); // ì œí’ˆ ëª©ë¡ë„ ê°±ì‹ 
            } else {
                showMessage(result.error || 'ìì¬ ìˆ˜ì • ì‹¤íŒ¨', 'error');
            }
        });

        async function deleteMaterial(id) {
            if (!confirm('ì´ ìì¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ì œí’ˆ ë ˆì‹œí”¼ì—ì„œ ì œê±°ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const response = await fetch(`/api/materials/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                showMessage('ìì¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadMaterials();
            }
        }

        // ë ˆì‹œí”¼ ë‹¨ìœ„ ë¼ë²¨ ì—…ë°ì´íŠ¸
        function updateRecipeUnitLabel() {
            const select = document.getElementById('recipe-material-select');
            const materialId = parseInt(select.value);
            const material = allMaterials.find(m => m.id === materialId);
            const label = document.getElementById('recipe-unit-label');

            if (material) {
                label.textContent = `(${material.unit})`;
            } else {
                label.textContent = '(ë‹¨ìœ„)';
            }
        }

        // ë ˆì‹œí”¼ ê´€ë¦¬
        async function openRecipeModal(productId, productName) {
            currentRecipeProductId = productId;
            document.getElementById('recipe-modal-title').textContent = `${productName} - ë ˆì‹œí”¼ ê´€ë¦¬`;

            // ìì¬ ëª©ë¡ ë¡œë“œ (ë“œë¡­ë‹¤ìš´ìš©)
            if (allMaterials.length === 0) {
                const response = await fetch('/api/materials');
                allMaterials = await response.json();
            }

            const select = document.getElementById('recipe-material-select');
            select.innerHTML = '<option value="">ìì¬ ì„ íƒ...</option>' +
                allMaterials.map(m => {
                    const pricePerUnit = m.price_per_unit || m.price_per_gram || 0;
                    return `<option value="${m.id}">${m.name} (${pricePerUnit.toFixed(2)}ì›/${m.unit})</option>`;
                }).join('');

            await loadRecipe();
            document.getElementById('recipe-modal').style.display = 'block';
        }

        async function loadRecipe() {
            const response = await fetch(`/api/products/${currentRecipeProductId}/recipe`);
            const recipe = await response.json();

            const recipeList = document.getElementById('recipe-list');
            if (recipe.length === 0) {
                recipeList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìì¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
                document.getElementById('recipe-total-cost').textContent = '0ì›';
                return;
            }

            let totalCost = 0;
            recipeList.innerHTML = recipe.map(r => {
                const pricePerUnit = r.price_per_unit || r.price_per_gram || 0;
                const itemCost = r.quantity * pricePerUnit;
                totalCost += itemCost;
                return `
                    <div class="recipe-item">
                        <div class="recipe-info">
                            <strong>${r.name}</strong> - ${r.quantity}${r.unit} Ã— ${pricePerUnit.toFixed(2)}ì›/${r.unit}
                            = <span class="cost-display">${formatCurrency(itemCost)}ì›</span>
                        </div>
                        <div class="recipe-actions">
                            <input type="number" step="0.01" value="${r.quantity}" style="width: 80px;" placeholder="${r.unit}"
                                   onchange="updateRecipeQuantity(${r.id}, this.value)">
                            <button class="btn-danger btn-small" onclick="deleteRecipeItem(${r.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recipe-total-cost').textContent = formatCurrency(totalCost) + 'ì›';
        }

        async function addMaterialToRecipe() {
            const materialId = document.getElementById('recipe-material-select').value;
            const quantity = document.getElementById('recipe-material-quantity').value;

            if (!materialId || !quantity || parseFloat(quantity) <= 0) {
                showMessage('ìì¬ì™€ ì‚¬ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const response = await fetch(`/api/products/${currentRecipeProductId}/recipe`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ material_id: materialId, quantity: quantity })
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ìì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                document.getElementById('recipe-material-quantity').value = '';
                await loadRecipe();
                loadProducts(); // ì œí’ˆ ëª©ë¡ ê°±ì‹  (ì›ê°€ ì—…ë°ì´íŠ¸)
            } else {
                showMessage(result.error || 'ìì¬ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        }

        async function updateRecipeQuantity(recipeId, quantity) {
            const response = await fetch(`/api/products/${currentRecipeProductId}/recipe/${recipeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: quantity })
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ì‚¬ìš©ëŸ‰ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                await loadRecipe();
                loadProducts();
            } else {
                showMessage(result.error || 'ìˆ˜ì • ì‹¤íŒ¨', 'error');
            }
        }

        async function deleteRecipeItem(recipeId) {
            if (!confirm('ì´ ìì¬ë¥¼ ë ˆì‹œí”¼ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const response = await fetch(`/api/products/${currentRecipeProductId}/recipe/${recipeId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ìì¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                await loadRecipe();
                loadProducts();
            }
        }

        function closeRecipeModal() {
            document.getElementById('recipe-modal').style.display = 'none';
        }

        // ==================== ìì¬ ë ˆì‹œí”¼ ê´€ë¦¬ ====================
        let currentMaterialRecipeId = null;

        // ìì¬ ë ˆì‹œí”¼ ë‹¨ìœ„ ë¼ë²¨ ì—…ë°ì´íŠ¸
        function updateMaterialRecipeUnitLabel() {
            const select = document.getElementById('material-recipe-material-select');
            const materialId = parseInt(select.value);
            const material = allMaterials.find(m => m.id === materialId);
            const label = document.getElementById('material-recipe-unit-label');

            if (material) {
                label.textContent = `(${material.unit})`;
            } else {
                label.textContent = '(ë‹¨ìœ„)';
            }
        }

        // ìì¬ ë ˆì‹œí”¼ ëª¨ë‹¬ ì—´ê¸°
        async function openMaterialRecipeModal(materialId, materialName) {
            currentMaterialRecipeId = materialId;
            document.getElementById('material-recipe-modal-title').textContent = `${materialName} - ë ˆì‹œí”¼ ê´€ë¦¬`;

            // ìì¬ ëª©ë¡ ë¡œë“œ (í”„ë© ì œì™¸ - í”„ë©ì´ í”„ë©ì„ ì¬ë£Œë¡œ ì“¸ ìˆ˜ ì—†ìŒ)
            if (allMaterials.length === 0) {
                const response = await fetch('/api/materials');
                allMaterials = await response.json();
            }

            const select = document.getElementById('material-recipe-material-select');
            select.innerHTML = '<option value="">ìì¬ ì„ íƒ...</option>' +
                allMaterials
                    .filter(m => m.type !== 'í”„ë©' && m.id !== materialId) // í”„ë©ê³¼ ìê¸° ìì‹  ì œì™¸
                    .map(m => {
                        const pricePerUnit = m.price_per_unit || m.price_per_gram || 0;
                        return `<option value="${m.id}">${m.name} (${pricePerUnit.toFixed(2)}ì›/${m.unit})</option>`;
                    }).join('');

            await loadMaterialRecipe();
            document.getElementById('material-recipe-modal').style.display = 'block';
        }

        // ìì¬ ë ˆì‹œí”¼ ë¡œë“œ
        async function loadMaterialRecipe() {
            const response = await fetch(`/api/materials/${currentMaterialRecipeId}/recipe`);
            const data = await response.json();
            const recipe = data.recipe || [];

            const recipeList = document.getElementById('material-recipe-list');
            if (recipe.length === 0) {
                recipeList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¬ë£Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>';
                document.getElementById('material-recipe-total-cost').textContent = '0ì›';
                return;
            }

            let totalCost = 0;
            recipeList.innerHTML = recipe.map(r => {
                const pricePerUnit = r.price_per_unit || r.price_per_gram || 0;
                const itemCost = r.quantity * pricePerUnit;
                totalCost += itemCost;
                return `
                    <div class="recipe-item">
                        <div class="recipe-info">
                            <strong>${r.name}</strong> (<span class="type-${r.type}">${r.type}</span>) - ${r.quantity}${r.unit} Ã— ${pricePerUnit.toFixed(2)}ì›/${r.unit}
                            = <span class="cost-display">${formatCurrency(itemCost)}ì›</span>
                        </div>
                        <div class="recipe-actions">
                            <button class="btn-danger btn-small" onclick="deleteIngredientFromMaterialRecipe(${r.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('material-recipe-total-cost').textContent = formatCurrency(totalCost) + 'ì›';
        }

        // ìì¬ ë ˆì‹œí”¼ì— ì¬ë£Œ ì¶”ê°€
        async function addIngredientToMaterialRecipe() {
            const materialId = document.getElementById('material-recipe-material-select').value;
            const quantity = document.getElementById('material-recipe-quantity').value;

            if (!materialId || !quantity || parseFloat(quantity) <= 0) {
                showMessage('ìì¬ì™€ ì‚¬ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const response = await fetch(`/api/materials/${currentMaterialRecipeId}/recipe`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ material_id: materialId, quantity: quantity })
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ì¬ë£Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                document.getElementById('material-recipe-quantity').value = '';
                await loadMaterialRecipe();
                loadMaterials(); // ìì¬ ëª©ë¡ ê°±ì‹  (ì›ê°€ ì—…ë°ì´íŠ¸)
            } else {
                showMessage(result.error || 'ì¬ë£Œ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        }

        // ìì¬ ë ˆì‹œí”¼ì—ì„œ ì¬ë£Œ ì‚­ì œ
        async function deleteIngredientFromMaterialRecipe(recipeId) {
            if (!confirm('ì´ ì¬ë£Œë¥¼ ë ˆì‹œí”¼ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const response = await fetch(`/api/materials/recipe/${recipeId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                showMessage('ì¬ë£Œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                await loadMaterialRecipe();
                loadMaterials();
            }
        }

        // ìì¬ ë ˆì‹œí”¼ ëª¨ë‹¬ ë‹«ê¸°
        function closeMaterialRecipeModal() {
            document.getElementById('material-recipe-modal').style.display = 'none';
        }

        // ==================== ì…ê³  ê´€ë¦¬ ====================

        // ì…ê³  ì´ë ¥ ë¡œë“œ
        async function loadReceipts() {
            const materialId = document.getElementById('receipt-filter-material').value;
            const startDate = document.getElementById('receipt-filter-start').value;
            const endDate = document.getElementById('receipt-filter-end').value;

            const params = new URLSearchParams();
            if (materialId) params.append('material_id', materialId);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            const response = await fetch(`/api/material-receipts?${params}`);
            const receipts = await response.json();
            const tbody = document.querySelector('#receipts-table tbody');

            if (receipts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                tbody.innerHTML = receipts.map(r => `
                    <tr>
                        <td>${r.receipt_date}</td>
                        <td>${r.material_name}</td>
                        <td><span class="category-badge category-${r.type}">${r.type}</span></td>
                        <td style="text-align: right;">${formatCurrency(r.quantity)}</td>
                        <td>${r.unit}</td>
                        <td class="cost-display" style="text-align: right;">${formatCurrency(r.unit_price)}ì›</td>
                        <td class="price-display" style="text-align: right; font-weight: 600;">${formatCurrency(r.quantity * r.unit_price)}ì›</td>
                        <td>${r.supplier || '-'}</td>
                        <td>${r.note || '-'}</td>
                        <td>
                            <button class="btn-small btn-secondary" onclick="deleteReceipt(${r.id}, '${r.material_name}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');
            }

            // ìì¬ë³„ í‰ê·  ë‹¨ê°€ ë¡œë“œ
            loadMaterialAveragePrices();

            // ìì¬ ëª©ë¡ ë¡œë“œ (ë“œë¡­ë‹¤ìš´ìš©)
            await loadMaterialsForReceipt();
        }

        // ìì¬ ëª©ë¡ ë¡œë“œ (ì…ê³  ë“±ë¡ìš©)
        async function loadMaterialsForReceipt() {
            const response = await fetch('/api/materials');
            const materials = await response.json();

            // ì…ê³  ë“±ë¡ í¼ ìì¬ ì„ íƒ
            const receiptMaterialSelect = document.getElementById('receipt-material');
            receiptMaterialSelect.innerHTML = '<option value="">ìì¬ ì„ íƒ</option>' +
                materials.map(m => `<option value="${m.id}">${m.name} (${m.type})</option>`).join('');

            // í•„í„° ìì¬ ì„ íƒ
            const filterMaterialSelect = document.getElementById('receipt-filter-material');
            filterMaterialSelect.innerHTML = '<option value="">ì „ì²´ ìì¬</option>' +
                materials.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        // ì…ê³  ë“±ë¡ í¼ ì œì¶œ
        document.getElementById('receipt-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                material_id: document.getElementById('receipt-material').value,
                receipt_date: document.getElementById('receipt-date').value,
                quantity: parseFloat(document.getElementById('receipt-quantity').value),
                unit_price: parseFloat(document.getElementById('receipt-unit-price').value),
                supplier: document.getElementById('receipt-supplier').value,
                note: document.getElementById('receipt-note').value
            };

            try {
                const response = await fetch('/api/material-receipts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… ì…ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    e.target.reset();
                    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
                    document.getElementById('receipt-date').valueAsDate = new Date();
                    loadReceipts();
                } else {
                    showMessage('ì…ê³  ë“±ë¡ ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        });

        // ì…ê³  ì‚­ì œ
        async function deleteReceipt(receiptId, materialName) {
            if (!confirm(`${materialName}ì˜ ì…ê³  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í›„ í‰ê·  ë‹¨ê°€ê°€ ì¬ê³„ì‚°ë©ë‹ˆë‹¤.`)) return;

            try {
                const response = await fetch(`/api/material-receipts/${receiptId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('ì…ê³  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadReceipts();
                } else {
                    showMessage('ì‚­ì œ ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        // ìì¬ë³„ í‰ê·  ë‹¨ê°€ ë¡œë“œ
        async function loadMaterialAveragePrices() {
            const response = await fetch('/api/materials');
            const materials = await response.json();
            const container = document.getElementById('material-avg-prices');

            const pricePromises = materials.map(async (material) => {
                const priceResponse = await fetch(`/api/materials/${material.id}/average-price`);
                const priceData = await priceResponse.json();
                return { ...material, ...priceData };
            });

            const materialsWithPrices = await Promise.all(pricePromises);

            container.innerHTML = materialsWithPrices.map(m => `
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #667eea;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${m.name}</div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">${m.type}</div>
                    <div style="font-size: 1.2em; font-weight: 600; color: #667eea;">
                        ${formatCurrency(m.avg_price)}ì›/${m.unit}
                    </div>
                    <div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                        ì…ê³  ${m.receipt_count || 0}íšŒ Â· ì´ ${formatCurrency(m.total_quantity || 0)}${m.unit}
                    </div>
                </div>
            `).join('');
        }

        // ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
        let salesTrendChartInstance = null;
        let categoryPieChartInstance = null;
        let topProductsChartInstance = null;
        let worstProductsChartInstance = null;

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ë Œë”ë§
        async function loadDashboard() {
            const days = parseInt(document.getElementById('dashboard-days').value) || 30;

            try {
                const response = await fetch(`/api/dashboard/data?days=${days}`);
                const data = await response.json();

                // ë©”íŠ¸ë¦­ ì¹´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('dashboard-total-sales').textContent = formatCurrency(data.stats.total_sales) + 'ì›';
                document.getElementById('dashboard-total-production').textContent = formatCurrency(data.stats.total_cost) + 'ì›';
                document.getElementById('dashboard-total-margin').textContent = formatCurrency(data.stats.total_margin) + 'ì›';
                document.getElementById('dashboard-total-donation').textContent = formatCurrency(data.stats.total_donation) + 'ì›';
                document.getElementById('dashboard-avg-margin-rate').textContent = data.stats.avg_margin_rate.toFixed(1) + '%';

                // 1. ì¼ë³„ íŒë§¤ ì¶”ì´ ì°¨íŠ¸
                renderSalesTrendChart(data.daily_sales);

                // 2. ì¹´í…Œê³ ë¦¬ ë¶„í¬ ì°¨íŠ¸
                renderCategoryPieChart(data.category_sales);

                // 3. ìƒìœ„ ì œí’ˆ ì°¨íŠ¸
                renderTopProductsChart(data.top_products);

                // 4. í•˜ìœ„ ì œí’ˆ ì°¨íŠ¸
                renderWorstProductsChart(data.worst_products);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì¼ë³„ íŒë§¤ ì¶”ì´ ì°¨íŠ¸
        function renderSalesTrendChart(dailySales) {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (salesTrendChartInstance) {
                salesTrendChartInstance.destroy();
            }

            const labels = dailySales.map(d => d.date.substring(5)); // MM-DD í˜•ì‹
            const totalSalesData = dailySales.map(d => d.total_sales);

            salesTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ë³„ íŒë§¤ê¸ˆì•¡',
                        data: totalSalesData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y) + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value) + 'ì›';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // ì¹´í…Œê³ ë¦¬ ë¶„í¬ ì°¨íŠ¸
        function renderCategoryPieChart(categorySales) {
            const ctx = document.getElementById('categoryPieChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (categoryPieChartInstance) {
                categoryPieChartInstance.destroy();
            }

            const labels = categorySales.map(c => c.category);
            const data = categorySales.map(c => c.total_sales);
            const colors = [
                '#667eea', '#f56565', '#48bb78', '#ed8936',
                '#9f7aea', '#38b2ac', '#f687b3', '#4299e1',
                '#ecc94b', '#ed64a6'
            ];

            categoryPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed) + 'ì›';
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ìƒìœ„ ì œí’ˆ ì°¨íŠ¸
        function renderTopProductsChart(topProducts) {
            const ctx = document.getElementById('topProductsChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (topProductsChartInstance) {
                topProductsChartInstance.destroy();
            }

            const labels = topProducts.map(p => p.name);
            const data = topProducts.map(p => p.total_sales);

            topProductsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'íŒë§¤ê¸ˆì•¡',
                        data: data,
                        backgroundColor: '#48bb78',
                        borderColor: '#38a169',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'íŒë§¤ê¸ˆì•¡: ' + formatCurrency(context.parsed.x) + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value) + 'ì›';
                                }
                            }
                        }
                    }
                }
            });
        }

        // í•˜ìœ„ ì œí’ˆ ì°¨íŠ¸
        function renderWorstProductsChart(worstProducts) {
            const ctx = document.getElementById('worstProductsChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (worstProductsChartInstance) {
                worstProductsChartInstance.destroy();
            }

            const labels = worstProducts.map(p => p.name);
            const data = worstProducts.map(p => p.total_sales);

            worstProductsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'íŒë§¤ê¸ˆì•¡',
                        data: data,
                        backgroundColor: '#f56565',
                        borderColor: '#e53e3e',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'íŒë§¤ê¸ˆì•¡: ' + formatCurrency(context.parsed.x) + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value) + 'ì›';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ í•¨ìˆ˜ =====
        async function uploadExcelFile() {
            const fileInput = document.getElementById('excel-upload-file');
            const resultDiv = document.getElementById('excel-upload-result');

            if (!fileInput.files.length) {
                showMessage('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: #666;">â³ ì—…ë¡œë“œ ì¤‘...</p>';

            try {
                const response = await fetch('/api/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    let html = '<h4 style="margin-bottom: 10px; color: #2e7d32;">âœ… ì—…ë¡œë“œ ì™„ë£Œ</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">';
                    html += `<div><strong>ì œí’ˆ ë“±ë¡:</strong> ${data.products_added}ê°œ</div>`;
                    html += `<div><strong>ìì¬ ë“±ë¡:</strong> ${data.materials_added}ê°œ</div>`;
                    html += `<div><strong>ê±´ë„ˆëœ€ (ì¤‘ë³µ):</strong> ${data.skipped}ê°œ</div>`;
                    html += '</div>';
                    if (data.errors && data.errors.length > 0) {
                        html += '<details><summary style="cursor:pointer; color:#dc3545;">âš ï¸ ì˜¤ë¥˜ ' + data.errors.length + 'ê±´</summary>';
                        html += '<ul style="margin-top:5px; font-size:12px;">';
                        data.errors.forEach(e => html += `<li>${e}</li>`);
                        html += '</ul></details>';
                    }
                    resultDiv.innerHTML = html;
                    showMessage(`ì œí’ˆ ${data.products_added}ê°œ, ìì¬ ${data.materials_added}ê°œ ë“±ë¡ ì™„ë£Œ!`, 'success');
                    loadProducts();
                    loadMaterials();
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">âŒ ${data.error}</p>`;
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #dc3545;">âŒ ì˜¤ë¥˜: ${error.message}</p>`;
                showMessage('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }

            fileInput.value = '';
        }

        // ===== ì´ì¹´ìš´íŠ¸ ì—°ë™ í•¨ìˆ˜ =====

        // ì´ì¹´ìš´íŠ¸ ì„¤ì • ì €ì¥
        document.getElementById('ecount-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                com_code: document.getElementById('ecount-com-code').value.trim(),
                user_id: document.getElementById('ecount-user-id').value.trim(),
                zone: document.getElementById('ecount-zone').value.trim().toUpperCase(),
                api_cert_key: document.getElementById('ecount-api-key').value.trim(),
                wh_cd: document.getElementById('ecount-wh-cd').value.trim() || '001',
                lan_type: 'ko-KR'
            };

            try {
                const response = await fetch('/api/ecount/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showMessage('ì´ì¹´ìš´íŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    loadEcountStats();
                } else {
                    showMessage('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        });

        // ì´ì¹´ìš´íŠ¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEcountSettings() {
            try {
                const response = await fetch('/api/ecount/settings');
                const settings = await response.json();

                if (settings) {
                    document.getElementById('ecount-com-code').value = settings.com_code;
                    document.getElementById('ecount-user-id').value = settings.user_id;
                    document.getElementById('ecount-zone').value = settings.zone;
                    document.getElementById('ecount-wh-cd').value = settings.wh_cd || '001';
                    // API í‚¤ëŠ” ë³´ì•ˆìƒ ì¼ë¶€ë§Œ í‘œì‹œ
                    document.getElementById('ecount-api-key').value = '';
                    document.getElementById('ecount-api-key').placeholder = `ì €ì¥ëœ í‚¤: ${settings.api_cert_key}`;
                    showMessage('ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showMessage('ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì´ì¹´ìš´íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testEcountConnection() {
            try {
                showMessage('ì´ì¹´ìš´íŠ¸ì— ì—°ê²° ì¤‘...', 'success');

                const response = await fetch('/api/ecount/test', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('âœ… ì´ì¹´ìš´íŠ¸ ì—°ê²° ì„±ê³µ! SESSION_IDë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showMessage('âŒ ì—°ê²° ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì´ì¹´ìš´íŠ¸ ë™ê¸°í™” í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEcountStats() {
            try {
                const response = await fetch('/api/ecount/sync-stats');
                const stats = await response.json();

                document.getElementById('ecount-stat-total').textContent = stats.total + 'ê±´';
                document.getElementById('ecount-stat-success').textContent = stats.success + 'ê±´';
                document.getElementById('ecount-stat-failed').textContent = stats.failed + 'ê±´';

                const rate = stats.total > 0 ? ((stats.success / stats.total) * 100).toFixed(1) : 0;
                document.getElementById('ecount-stat-rate').textContent = rate + '%';
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‚ ì§œ ë²”ìœ„ë¡œ ë°ì´í„° ë™ê¸°í™”
        async function syncDataByDateRange() {
            const syncType = document.getElementById('sync-type').value;
            const startDate = document.getElementById('sync-start-date').value;
            const endDate = document.getElementById('sync-end-date').value;

            if (!startDate || !endDate) {
                showMessage('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm(`${startDate}ë¶€í„° ${endDate}ê¹Œì§€ì˜ ë°ì´í„°ë¥¼ ì´ì¹´ìš´íŠ¸ì— ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            showMessage('ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ëŠ” ì¤‘...', 'success');

            try {
                // ë¨¼ì € í•´ë‹¹ ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
                let endpoint, dataEndpoint;

                if (syncType === 'production') {
                    dataEndpoint = `/api/production?start_date=${startDate}&end_date=${endDate}`;
                    endpoint = '/api/ecount/sync/production/batch';
                } else {
                    dataEndpoint = `/api/material-receipts?start_date=${startDate}&end_date=${endDate}`;
                    endpoint = '/api/ecount/sync/receipt/batch';
                }

                // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const dataResponse = await fetch(dataEndpoint);
                const records = await dataResponse.json();

                if (records.length === 0) {
                    showMessage('í•´ë‹¹ ê¸°ê°„ì— ë™ê¸°í™”í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const ids = records.map(r => r.id);

                // ë°°ì¹˜ ë™ê¸°í™” ì‹¤í–‰
                const syncResponse = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(syncType === 'production' ? { production_ids: ids } : { receipt_ids: ids })
                });

                const result = await syncResponse.json();

                showMessage(
                    `ë™ê¸°í™” ì™„ë£Œ: ì„±ê³µ ${result.success}ê±´, ì‹¤íŒ¨ ${result.failed}ê±´`,
                    result.failed > 0 ? 'error' : 'success'
                );

                // í†µê³„ ë° ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                loadEcountStats();
                loadEcountLogs();

            } catch (error) {
                showMessage('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        // ì´ì¹´ìš´íŠ¸ ë™ê¸°í™” ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEcountLogs() {
            const filterType = document.getElementById('log-filter-type').value;
            const tbody = document.getElementById('ecount-logs-tbody');

            try {
                let url = '/api/ecount/sync-logs?limit=50';
                if (filterType) {
                    url += `&type=${filterType}`;
                }

                const response = await fetch(url);
                const logs = await response.json();

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ë™ê¸°í™” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const statusBadge = log.status === 'success'
                        ? '<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âœ… ì„±ê³µ</span>'
                        : '<span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 4px; font-size: 11px;">âŒ ì‹¤íŒ¨</span>';

                    const syncTypeLabel = log.sync_type === 'sale' ? 'íŒë§¤' : 'ë§¤ì…';

                    return `
                        <tr>
                            <td>${new Date(log.created_at).toLocaleString('ko-KR')}</td>
                            <td>${syncTypeLabel}</td>
                            <td>${log.record_id || '-'}</td>
                            <td>${statusBadge}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${log.error_message || '-'}
                            </td>
                            <td>
                                <button class="btn-small" onclick="showLogDetail(${log.id})">ìƒì„¸</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                console.error('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¡œê·¸ ìƒì„¸ ë³´ê¸°
        async function showLogDetail(logId) {
            try {
                const response = await fetch(`/api/ecount/sync-logs?limit=1000`);
                const logs = await response.json();
                const log = logs.find(l => l.id === logId);

                if (!log) {
                    alert('ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                let detail = `=== ë™ê¸°í™” ë¡œê·¸ ìƒì„¸ ===\n\n`;
                detail += `ID: ${log.id}\n`;
                detail += `ìœ í˜•: ${log.sync_type}\n`;
                detail += `ë ˆì½”ë“œ ID: ${log.record_id}\n`;
                detail += `ë ˆì½”ë“œ íƒ€ì…: ${log.record_type}\n`;
                detail += `ìƒíƒœ: ${log.status}\n`;
                detail += `ì‹œê°„: ${new Date(log.created_at).toLocaleString('ko-KR')}\n\n`;

                if (log.error_message) {
                    detail += `âŒ ì˜¤ë¥˜ ë©”ì‹œì§€:\n${log.error_message}\n\n`;
                }

                if (log.request_data) {
                    detail += `ğŸ“¤ ìš”ì²­ ë°ì´í„°:\n${JSON.stringify(JSON.parse(log.request_data), null, 2)}\n\n`;
                }

                if (log.response_data) {
                    detail += `ğŸ“¥ ì‘ë‹µ ë°ì´í„°:\n${JSON.stringify(JSON.parse(log.response_data), null, 2)}`;
                }

                alert(detail);
            } catch (error) {
                alert('ë¡œê·¸ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        // ===== CSV ìë™ ë§¤ì¹­ ê¸°ëŠ¥ =====
        let matchResultsData = null;

        // CSV íŒŒì¼ íŒŒì‹±
        async function parseEcountCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        showMessage('CSV íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    // í—¤ë” ì°¾ê¸° (í’ˆëª©ì½”ë“œ, í’ˆëª©ëª… ì—´)
                    const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const codeIndex = header.findIndex(h => h.includes('í’ˆëª©') && h.includes('ì½”ë“œ'));
                    const nameIndex = header.findIndex(h => h.includes('í’ˆëª©ëª…'));

                    if (codeIndex === -1 || nameIndex === -1) {
                        showMessage('CSV íŒŒì¼ì— "í’ˆëª©ì½”ë“œ"ì™€ "í’ˆëª©ëª…" ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                        return;
                    }

                    // ë°ì´í„° íŒŒì‹±
                    const csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',').map(cell => cell.trim().replace(/"/g, ''));
                        if (row[codeIndex] && row[nameIndex]) {
                            csvData.push({
                                code: row[codeIndex],
                                name: row[nameIndex]
                            });
                        }
                    }

                    if (csvData.length === 0) {
                        showMessage('CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    showMessage(`CSV íŒŒì¼ íŒŒì‹± ì™„ë£Œ: ${csvData.length}ê°œ í•­ëª©`);

                    // ì„œë²„ì— ë§¤ì¹­ ìš”ì²­
                    await matchProductsWithEcount(csvData);

                } catch (error) {
                    showMessage('CSV íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + error.message, 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // ì œí’ˆ ë§¤ì¹­ ìš”ì²­
        async function matchProductsWithEcount(csvData) {
            try {
                const response = await fetch('/api/ecount/match-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_data: csvData })
                });

                const result = await response.json();

                if (result.success) {
                    matchResultsData = result;
                    displayMatchResults(result);
                    showMessage(`ë§¤ì¹­ ì™„ë£Œ! ì œí’ˆ ${result.matched_products}/${result.total_products}ê°œ, ìì¬ ${result.matched_materials}/${result.total_materials}ê°œ`);
                } else {
                    showMessage('ë§¤ì¹­ ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ë§¤ì¹­ ìš”ì²­ ì‹¤íŒ¨: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ
        function displayMatchResults(result) {
            document.getElementById('match-results').style.display = 'block';
            document.getElementById('match-total-products').textContent = result.total_products;
            document.getElementById('match-success-products').textContent = result.matched_products;
            document.getElementById('match-total-materials').textContent = result.total_materials;
            document.getElementById('match-success-materials').textContent = result.matched_materials;

            const tbody = document.getElementById('match-results-body');
            const allMatches = [...result.product_matches, ...result.material_matches];

            tbody.innerHTML = allMatches.map(match => {
                const statusText = match.matched ? 'âœ… ë§¤ì¹­ë¨' : 'âŒ ë¯¸ë§¤ì¹­';
                const statusColor = match.matched ? '#28a745' : '#dc3545';
                const typeLabel = match.type === 'product' ? 'ì œí’ˆ' : 'ìì¬';
                const suggestedCode = match.suggested_code || '-';
                const currentCode = match.current_code || '-';

                // ë§¤ì¹­ëœ í•­ëª©ë§Œ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
                return `
                    <tr style="background: ${match.matched ? '#f0f8ff' : 'white'}">
                        <td style="padding: 8px; border: 1px solid #ddd;">${typeLabel}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${match.name}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${currentCode}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${suggestedCode}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor};">${statusText}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            ${match.matched ? `<input type="checkbox" class="match-checkbox" data-id="${match.id}" data-type="${match.type}" data-code="${match.suggested_code}" checked>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ì„ íƒ í•­ëª© ì ìš©
        async function applySelectedMatches() {
            const checkboxes = document.querySelectorAll('.match-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage('ì ìš©í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const matches = Array.from(checkboxes).map(cb => ({
                id: parseInt(cb.dataset.id),
                type: cb.dataset.type,
                ecount_code: cb.dataset.code
            }));

            await applyMatches(matches);
        }

        // ëª¨ë“  ë§¤ì¹­ ì ìš©
        async function applyAllMatches() {
            if (!matchResultsData) {
                showMessage('ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const allMatches = [
                ...matchResultsData.product_matches.filter(m => m.matched),
                ...matchResultsData.material_matches.filter(m => m.matched)
            ].map(m => ({
                id: m.id,
                type: m.type,
                ecount_code: m.suggested_code
            }));

            if (allMatches.length === 0) {
                showMessage('ì ìš©í•  ë§¤ì¹­ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            await applyMatches(allMatches);
        }

        // ë§¤ì¹­ ì ìš© ì‹¤í–‰
        async function applyMatches(matches) {
            if (!confirm(`${matches.length}ê°œ í•­ëª©ì˜ ì´ì¹´ìš´íŠ¸ ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch('/api/ecount/apply-matches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ matches: matches })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message);
                    clearMatchResults();
                    // ì œí’ˆ/ìì¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    if (document.getElementById('products-tab').classList.contains('active')) {
                        loadProducts();
                    }
                    if (document.getElementById('materials-tab').classList.contains('active')) {
                        loadMaterials();
                    }
                } else {
                    showMessage('ì ìš© ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ì ìš© ìš”ì²­ ì‹¤íŒ¨: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ë§¤ì¹­ ê²°ê³¼ ì§€ìš°ê¸°
        function clearMatchResults() {
            document.getElementById('match-results').style.display = 'none';
            document.getElementById('match-results-body').innerHTML = '';
            document.getElementById('ecount-csv-file').value = '';
            matchResultsData = null;
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            ['edit-modal', 'recipe-modal', 'edit-material-modal', 'material-recipe-modal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) modal.style.display = 'none';
            });
        }

        // ì´ˆê¸° ë¡œë“œ
        loadGridData();

        // ì…ê³  ë‚ ì§œ ì´ˆê¸°í™”
        document.getElementById('receipt-date').valueAsDate = new Date();

        // ì´ì¹´ìš´íŠ¸ ë™ê¸°í™” ë‚ ì§œ ì´ˆê¸°í™” (ìµœê·¼ 7ì¼)
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 7);
        document.getElementById('sync-start-date').valueAsDate = weekAgo;
        document.getElementById('sync-end-date').valueAsDate = today;
    </script>
</body>
</html>
